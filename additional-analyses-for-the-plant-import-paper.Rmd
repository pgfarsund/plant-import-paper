---
title: "additional-analyses-for-the-plant-import-paper"
author: "pgfarsund"
date: '2023'
output: html_document
---

this markdown is a working document for analysing data from the plant import paper
(in prep for Biological Invasions). the following analyses might be implemented 
in the manuscript. 




```{r}
library(phyloseq)
library(tidyverse)
library(ggpubr)
```


load and manipulate phyloseq objects:
```{r}
### plants

# load data:
plants = readRDS(file = "plants-phyloseq-object.RDS") # change the path to data's location on your computer.

# manipulate the sample data:
sam = data.frame(plants@sam_data) %>% 
  dplyr::select("sample","Location_name",            # there is a lot of data we don't need.
                "Specific_host",
                "Sample_ID") %>% 
  rename(c("container"="Location_name",              # rename columns for simplicity.
           "host"="Specific_host", 
           "sample_id"="Sample_ID")) %>% 
  mutate(sample=sub("PLANTEIMP_21_", "", sample),    # easier to interpret sample number.
         sample=sub("_ITS_S2_ITS4", "", sample)) %>% 
  mutate(container = sub("Bil ", "", container)) %>% # remove "Bil " from the container ID.
  mutate(pot_id = c(rep(paste0("p", 1:5), each=2),   # add an ID to each pot - this will be
                    rep(paste0("p", 6:15), each=1),  # identical between samples taken from
                    rep(paste0("p", 16:20), each=2), # the same pot.
                    rep(paste0("p", 21:30), each=1),
                    rep(paste0("p", 31:35), each=2),
                    rep(paste0("p", 36:45), each=1),
                    rep(paste0("p", 46:50), each=2),
                    rep(paste0("p", 51:60), each=1))) %>%
  mutate(interval = c(rep("double", times=10),
                      rep("single", times=10),
                      rep("double", times=10),
                      rep("single", times=10),
                      rep("double", times=10),
                      rep("single", times=10), 
                      rep("double", times=10),
                      rep("single", times=10))); str(sam) 
sample_data(plants) = sample_data(sam); rm(sam); plants

# for this study we're only interested in vascular plants. our data set contains
# some bryophytes and green algae, additionally we're not interested in Taxus sp. 
# or Thuja sp., because these were ornamentals in the sampled soil. 
# remove non-focal taxa:
plants=subset_taxa(plants, phylum=="Streptophyta")
plants=subset_taxa(plants, class!="Chlorophyceae")
plants=subset_taxa(plants, order!="Splachnales")
plants=subset_taxa(plants, order!="Bryales")
plants=subset_taxa(plants, order!="Dicranales")
plants=subset_taxa(plants, order!="Funariales")
plants=subset_taxa(plants, order!="Hypnales")
plants=subset_taxa(plants, order!="Klebsormidiaceae")
plants=subset_taxa(plants, order!="Pottiales")
plants=subset_taxa(plants, order!="Pseudoditrichales")
plants=subset_taxa(plants, species!="Thuja_sp.")
plants=subset_taxa(plants, species!="Thuja_occidentalis")
plants=subset_taxa(plants, species!="Taxus_sp.")
plants=subset_taxa(plants, species!="Taxus_canadensis"); plants



### fungi

# load data:
fungi = readRDS(file = "fungi-phyloseq-object.RDS") # change the path to data's location on your computer
fungi = subset_samples(fungi, negative_control=="FALSE")

# manipulate the sample data:
sam = data.frame(fungi@sam_data) %>% 
  dplyr::select("sample","Location_name",            # there is a lot of data we don't need
                "Specific_host",
                "Sample_ID") %>%
  rename(c("container"="Location_name",              # rename columns for simplicity
           "host"="Specific_host", 
           "sample_id"="Sample_ID")) %>% 
  mutate(sample=sub("PLANTEIMP_21_", "", sample),    # easier to interpret sample number
         sample=sub("_fITS7_ITS4", "", sample)) %>% 
  mutate(container = sub("Bil ", "", container)) %>% # remove "Bil " from the container ID
  mutate(pot_id = c(rep(paste0("p", 1:5), each=2),   # add an ID to each pot - this will be
                    rep(paste0("p", 6:15), each=1),  # identical between samples taken from
                    rep(paste0("p", 16:20), each=2), # the same pot
                    rep(paste0("p", 21:30), each=1),
                    rep(paste0("p", 31:35), each=2),
                    rep(paste0("p", 36:45), each=1),
                    rep(paste0("p", 46:50), each=2),
                    rep(paste0("p", 51:60), each=1))) %>%
  mutate(interval = c(rep("double", times=10),
                      rep("single", times=10),
                      rep("double", times=10),
                      rep("single", times=10),
                      rep("double", times=10),
                      rep("single", times=10), 
                      rep("double", times=10),
                      rep("single", times=10)))
sample_data(fungi) = sample_data(sam); rm(sam); fungi
```









```{r}
# we're only interested in pots sampled twice in the coming model. pot 46 (p46) 
# lost its second sample during normalization, we therefore remove its first 
# sample from the dataset: 
p.rar = subset_samples(p.rar, pot_id!="p46"); p.rar # 

# make two phyloseq objects for the pots sampled twice - one for the first sample
# and one for the second sample. start with the first sample per pot:
dp = subset_samples(p.rar, interval=="double"); dp
dps = subset_samples(dp, sample_id!="1_2") # samples with sample_id = *_2 represent second sample per pot
dps = subset_samples(dps, sample_id!="2_2")
dps = subset_samples(dps, sample_id!="3_2")
dps = subset_samples(dps, sample_id!="4_2")
dps = subset_samples(dps, sample_id!="5_2") # filter out the second sample from every pot
dps = prune_taxa(taxa_sums(dps)>0, dps); dp; dps 

dps@sam_data$sampled_times = "one" # add a variable to distinguish from the second samples
dps@sam_data = sample_data(data.frame(cbind(dps@sam_data), 
                                      estimate_richness(dps, 
                                                        measures = "Observed"))); head(dps@sam_data) # estimate and record observed richness (ignore warning)

# create a data frame for easier modelling
obs.one.sams = data.frame(dps@sam_data) %>% 
  rename("obs_one_sample"="Observed"); head(obs.one.sams) # give Observed a better name


# now do the first+second sample:
dpm = merge_samples(dp, 
                    group = "pot_id"); dp; dpm # merge samples from corresponding pots

# fix pot_id and copy sample data from dps in a controlled manner:
dpm@sam_data$sampled_times = "two"; head(dpm@sam_data) # to distinguish from first samples
dpm@sam_data$pot_id = rownames(dpm@sam_data) 
dpm@sam_data$host = dps@sam_data$host
dpm@sam_data$container = dps@sam_data$container

dpm@sam_data = sample_data(data.frame(cbind(dpm@sam_data), 
                                      estimate_richness(dpm, 
                                                        measures = "Observed"))); head(dpm@sam_data) # estimate and record observed richness (ignore warning)

# create a data frame for easier modelling
obs.two.sams = data.frame(dpm@sam_data) %>% 
  rename("obs_two_samples"="Observed"); head(obs.two.sams) # give Observed a better name



# now combine the data into one data set:
fi.df = left_join(obs.one.sams, 
                  obs.two.sams, 
                  by = "pot_id") %>% 
  dplyr::select("pot_id", "host.x", "container.x", 
         "obs_one_sample", "obs_two_samples") %>% 
  dplyr::rename("container"="container.x",
                "host"="host.x") %>% 
  dplyr::mutate(fold_increase = obs_two_samples/obs_one_sample) 


# do some exploratory plotting:
ggarrange(
fi.df %>% 
  ggplot(aes(x=container, y=obs_one_sample)) + 
  geom_boxplot(),
fi.df %>% 
  ggplot(aes(x=container, y=obs_two_samples)) + 
  geom_boxplot(),
fi.df %>% 
  ggplot(aes(x=container, y=fold_increase)) + 
  geom_boxplot(),
nrow = 1)
#
ggarrange(
fi.df %>% 
  ggplot(aes(x=host, y=obs_one_sample)) + 
  geom_boxplot() + 
  facet_wrap(~container),
fi.df %>% 
  ggplot(aes(x=host, y=obs_two_samples)) + 
  geom_boxplot() + 
  facet_wrap(~container),
fi.df %>% 
  ggplot(aes(x=host, y=fold_increase)) + 
  geom_boxplot() + 
  facet_wrap(~container),
nrow = 3)
#


## fit a model: 

# fit the data to a suitable distribution: 
library(fitdistrplus) 

plotdist(fi.df$fold_increase, 
         histo = TRUE, demp = TRUE) # intial plotting

descdist(fi.df$fold_increase,
         boot = 1000) # skewness-kurtosis plot

x=fitdist(fi.df$fold_increase/10, 
          distr = "beta", method = "mle"); summary(x); plot(x) 

gofstat(x) # 

# fit a linear model to test the effect of container and host plant on the
# on observed species richness. include pot_id as a random effect to control
# for the fact that ca. half of the samples
library(lmerTest) # for fitting the model
library(effects) # for plotting effects of predictor variables


#

```



```{r}

# we're going to merge samples from the same pots. to do this, we first create a 
# new phyloseq object with only the samples we're going to merge: 
twice = subset_samples(fungi, interval == "double"); twice
twice.m = merge_samples(twice, group = "pot_id"); twice.m 

# reassign sample data in twice.m:
twice.m@sam_data$pot_id = rownames(twice.m@sam_data) # fix pot_id variable
twice.m@sam_data$pot_id = sub("p","",twice.m@sam_data$pot_id) 
twice.m@sam_data$pot_id = as.numeric(twice.m@sam_data$pot_id) # this will let us sort by pot_id
twice.m.sam = data.frame(twice.m@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id))

# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(sample_id!="1_2") %>%
  filter(sample_id!="2_2") %>%
  filter(sample_id!="3_2") %>%
  filter(sample_id!="4_2") %>%
  filter(sample_id!="5_2")

# and reassign variables: 
twice.m.sam$host = sam$host
twice.m.sam$container = sam$container
twice.m.sam$interval = sam$interval

# convert til sample_data() object:
twice.m.sam = sample_data(twice.m.sam); sample_names(twice.m.sam)

# and reassign to twice.m phyloseq object: 
sample_data(twice.m) = twice.m.sam; twice.m; head(twice.m@sam_data)


# now we want to get the merged samples back in the original dataset. we first
# create a new dataset with only samples from pots sampled once: 
once = subset_samples(fungi, interval == "single"); once

# and now we can merge the two phyloseq objects:
fungi2 = merge_phyloseq(twice.m, once); fungi2

sort(sample_sums(fungi2))
f2rar = rarefy_even_depth(fungi2, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = 237829); fungi2; f2rar

# now we're ready to have a look at observed species richness:
# make a dataframe for ease of testing and plotting:
obs.df = data.frame(cbind(estimate_richness(f2rar, 
                                            measures = "Observed"), 
                          sample_data(f2rar))); str(obs.df)

hist(obs.df$Observed); shapiro.test(obs.df$Observed) # not statistically significantly different from a normal distribution...
var.test(Observed ~ interval, obs.df) # variance is not significantly different between the two groups.
t.test(Observed ~ interval, obs.df, var.equal=TRUE)
si=obs.df %>% 
  filter(interval=="single"); sd(si$Observed); rm(si$Observed)
db=obs.df %>% 
  filter(interval=="double"); sd(db$Observed); rm(db$Observed)
#
obs.df %>% 
  ggplot(aes(x=interval, y=Observed, 
             fill=interval)) + 
  geom_boxplot(alpha = 0.6) + 
  scale_fill_manual(values = c("tan1", 
                               "gold1")) +
  theme_classic() + 
  ylab("Observed species richness") +
  scale_x_discrete(labels = c("Double", 
                              "Single")) +
  theme(legend.position = "none", 
        axis.title.x = element_blank())

```




###################################################

alpha diversity

PLANTS

we're interested in exploring the alpha diversity of contaminant plants and fungi.
we're going to fit models to determine which factors are important for determining
the diversity and composition of contaminant species in our samples. 

first normalize the number of sequences across samples:

```{r}
quantile(sample_sums(plants)); sort(sample_sums(plants))

# considering the read depth across all the samples, 21915 seems like a fair sample
# size to retain diversity (ASVs (species)) and power (samples) in the data set: 
p.rar = rarefy_even_depth(plants, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE,
                          sample.size = 21915); plants; p.rar
sort(data.frame(estimate_richness(p.rar, measures = "Observed"))$Observed)
```


model PLANT observed richness 

first we want to know which factors are important for the alpha diversity in each
individual soil sample. we therefore include all samples from all pots, and will
include pot_id as a random effect in our model to account for the fact that

```{r}
# create a data.frame with observed richness and sampling data:
obs = cbind(data.frame(estimate_richness(p.rar,
                                         measures = "Observed"),
                       sample_data(p.rar))); str(obs)

# we do some plotting to explore the data:
obs %>% 
  ggplot(aes(x=container, y=Observed, 
             fill=host)) + 
  geom_boxplot()

# it seems like there is a difference in observed species richness between thuja
# and taxus in container 1 but not in container 2. this indicates an interaction 
# effect between container and host. 

# before fitting our data to a model, we need to figure out what distribution
# bets fits our data. we use the package fitdistrplus for this:
library(fitdistrplus) # load package

# we found it difficult to fit the data to a suitable distribution. by log
# transforming the data, they're not significantly different from a normal
# distribution:
plotdist(sqrt(obs$Observed), 
         histo = TRUE, demp = TRUE) # intial plotting

descdist(sqrt(obs$Observed), 
         boot = 1000) # skewness-kurtosis plot

x=fitdist(sqrt(obs$Observed), 
          distr = "norm", 
          method = "mle"); summary(x); plot(x) 

gofstat(x) # not statistically significant different from a normal distribution. 

library(glmmTMB)
library(effects)
plant.model <- glmmTMB(formula = Observed/max(Observed+0.1) ~ container * host + (1|pot_id),
                       data = obs); summary(plant.model); plot(allEffects(plant.model))
library(DHARMa)
testDispersion(plant.model)

p.posthoc = emmeans(plant.model, 
                    list(pairwise ~ container*host), 
                    adjust = "Tukey"); p.posthoc # two significant pairwise comparisons


# review the model results:
p.mod1.res=summary(p.mod1); p.mod1.res
#

# make a pretty boxplot to go with results:
pmodbox <- obs %>% 
  ggplot(aes(x=container, y=Observed, 
             fill=host)) + 
  geom_boxplot(alpha = 0.75) +
  theme_classic() +
  scale_fill_manual(values = c("darkolivegreen1", 
                               "darkolivegreen")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.85, 0.85),
        legend.box.background = element_rect(colour = "black", 
                                             linewidth = 1),
        legend.margin = margin(3, 3, 3, 3)) +
  labs(title = "Contaminant plant richness"); pmodbox
#######

plotdist(log(obs$Observed), 
         histo = TRUE, demp = TRUE) # intial plotting

descdist(log(obs$Observed), 
         boot = 1000) # skewness-kurtosis plot

x=fitdist(log(obs$Observed), 
          distr = "norm", 
          method = "mle"); summary(x); plot(x) 

gofstat(x)

# fit a linear model to test the effect of container and host plant on the
# on observed species richness. include pot_id as a random effect to control
# for the fact that ca. half of the samples
library(lmerTest) # for fitting the model
library(effects) # for plotting effects of predictor variables

p.mod1 = lmerTest::lmer(formula = sqrt(Observed) ~ container * host + (1|pot_id),
                      data = obs); summary(p.mod1); plot(allEffects(p.mod1))

# we'll use DHARMa to validate the model's residuals:
library(DHARMa)
testDispersion(p.mod1)

sim.res.p.mod1 = simulateResiduals(p.mod1, 
                                   n = 250,
                                   plot = TRUE) # these simulated residuals look dandy

# review the model results:
p.mod1.res=summary(p.mod1); p.mod1.res
# seems host and host interacting with container had a significant on richness 
# in our samples. perform a post-hoc test with emmeans package:
library(emmeans)

p.posthoc = emmeans(p.mod1, 
                    list(pairwise ~ container*host), 
                    adjust = "Tukey"); p.posthoc # two significant pairwise comparisons

# make a nice figure to go with the results:
p = obs %>% 
  ggplot(aes(y=Observed, x=container,
             fill=host, group=interaction(container, 
                                          host))) +  
  theme_classic() +
  geom_boxplot(width=0.5, 
               #outlier.shape = NA,
               aes(fill=host), 
               alpha=0.4) + 
  scale_fill_manual(values = c("chartreuse1",
                               "steelblue1")) + 
  scale_y_continuous(breaks = seq(0, 15, 3)) +
  theme(legend.title = element_blank(), 
        legend.position = c(0.85,0.85), 
        legend.background = element_rect(colour = "black",
                                         fill = "grey95"), 
        legend.text = element_text()) + 
  annotate(geom = "text", label = c("A", "B", "AC", "AC"),
           x = c(0.88, 1.12, 1.88, 2.12), 
           y = c(14.5, 7.5, 13.5, 9.5)); p; p.mod1.res; summary(p.posthoc)
p.mod1.res
p.posthoc

library(effects)

effects::allEffects(p.mod1)
plot(allEffects(p.mod1))
```



model PLANT fold increase from one to two soil samples per pot

we next want to find out if container and host predict the fold increase (FI) in
observed species richness when sampling pots first once and then twice. for this
model we will only include pots that were sampled twice, and we will fit mixed 
effects models with random slopes because the data are paired 
(observed richness in 1st sample vs observed richness in 1st + 2nd samples)

NEED TO NORMALIZE FIRST:
  - normalizing all sams prior to merging = taking and seqing 2 per pot = expensive <-- this one, right?
  - normalizing singles alone and merged alone prior to comparison = simulating osil volume increase without increasing sampling seqing effort = cheaper <-- but not exactly what we're testing here, right? should do BOTH

```{r}
# we're only interested in pots sampled twice in the coming model. pot 46 (p46) 
# lost its second sample during normalization, we therefore remove its first 
# sample from the dataset: 
p.rar = subset_samples(p.rar, pot_id!="p46"); p.rar # 

# make two phyloseq objects for the pots sampled twice - one for the first sample
# and one for the second sample. start with the first sample per pot:
dp = subset_samples(p.rar, interval=="double"); dp
dps = subset_samples(dp, sample_id!="1_2") # samples with sample_id = *_2 represent second sample per pot
dps = subset_samples(dps, sample_id!="2_2")
dps = subset_samples(dps, sample_id!="3_2")
dps = subset_samples(dps, sample_id!="4_2")
dps = subset_samples(dps, sample_id!="5_2") # filter out the second sample from every pot
dps = prune_taxa(taxa_sums(dps)>0, dps); dp; dps 

dps@sam_data$sampled_times = "one" # add a variable to distinguish from the second samples
dps@sam_data = sample_data(data.frame(cbind(dps@sam_data), 
                                      estimate_richness(dps, 
                                                        measures = "Observed"))); head(dps@sam_data) # estimate and record observed richness (ignore warning)

# create a data frame for easier modelling
obs.one.sams = data.frame(dps@sam_data) %>% 
  rename("obs_one_sample"="Observed"); head(obs.one.sams) # give Observed a better name


# now do the first+second sample:
dpm = merge_samples(dp, 
                    group = "pot_id"); dp; dpm # merge samples from corresponding pots

# fix pot_id and copy sample data from dps in a controlled manner:
dpm@sam_data$sampled_times = "two"; head(dpm@sam_data) # to distinguish from first samples
dpm@sam_data$pot_id = rownames(dpm@sam_data) 
dpm@sam_data$host = dps@sam_data$host
dpm@sam_data$container = dps@sam_data$container

dpm@sam_data = sample_data(data.frame(cbind(dpm@sam_data), 
                                      estimate_richness(dpm, 
                                                        measures = "Observed"))); head(dpm@sam_data) # estimate and record observed richness (ignore warning)

# create a data frame for easier modelling
obs.two.sams = data.frame(dpm@sam_data) %>% 
  rename("obs_two_samples"="Observed"); head(obs.two.sams) # give Observed a better name



# now combine the data into one data set:
fi.df = left_join(obs.one.sams, 
                  obs.two.sams, 
                  by = "pot_id") %>% 
  dplyr::select("pot_id", "host.x", "container.x", 
         "obs_one_sample", "obs_two_samples") %>% 
  dplyr::rename("container"="container.x",
                "host"="host.x") %>% 
  dplyr::mutate(fold_increase = obs_two_samples/obs_one_sample) 


# do some exploratory plotting:
ggarrange(
fi.df %>% 
  ggplot(aes(x=container, y=obs_one_sample)) + 
  geom_boxplot(),
fi.df %>% 
  ggplot(aes(x=container, y=obs_two_samples)) + 
  geom_boxplot(),
fi.df %>% 
  ggplot(aes(x=container, y=fold_increase)) + 
  geom_boxplot(),
nrow = 1)
#
ggarrange(
fi.df %>% 
  ggplot(aes(x=host, y=obs_one_sample)) + 
  geom_boxplot() + 
  facet_wrap(~container),
fi.df %>% 
  ggplot(aes(x=host, y=obs_two_samples)) + 
  geom_boxplot() + 
  facet_wrap(~container),
fi.df %>% 
  ggplot(aes(x=host, y=fold_increase)) + 
  geom_boxplot() + 
  facet_wrap(~container),
nrow = 3)
#


## fit a model: 

# fit the data to a suitable distribution: 
library(fitdistrplus) 

plotdist(fi.df$fold_increase, 
         histo = TRUE, demp = TRUE) # intial plotting

descdist(fi.df$fold_increase,
         boot = 1000) # skewness-kurtosis plot

x=fitdist(fi.df$fold_increase/10, 
          distr = "beta", 
          method = "mle"); summary(x); plot(x) 

gofstat(x) # 

# fit a linear model to test the effect of container and host plant on the
# on observed species richness. include pot_id as a random effect to control
# for the fact that ca. half of the samples
library(glmmTMB) # for fitting the model
library(effects) # for plotting effects of predictor variables

p.mod2 <- glmmTMB(formula = fold_increase/10 ~ container + host + (1|pot_id),
                  data = fi.df); summary(p.mod2); plot(allEffects(p.mod2))

# we'll use DHARMa to validate the model's residuals:
library(DHARMa)
testDispersion(p.mod1)

sim.res.p.mod1 = simulateResiduals(p.mod1, 
                                   n = 250,
                                   plot = TRUE) # these simulated residuals look dandy

# review the model results:
p.mod1.res=summary(p.mod1); p.mod1.res

#

```




make extrapolated species accumulation curves

we're interested in approximating how many pots would have to be sampled per 
container to identify all contaminant species per container. we can extrapolate
based on our samples to get an estimate of this. we'll use the iNEXT package

PLANTS:

```{r}
library(iNEXT)

a <- subset_samples(plants, sample_id!="1_2"); a
a <- subset_samples(a, sample_id!="2_2"); a
a <- subset_samples(a, sample_id!="3_2"); a
a <- subset_samples(a, sample_id!="4_2"); a
a <- subset_samples(a, sample_id!="5_2"); a
sort(sample_sums(a))
p.rar = rarefy_even_depth(a, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE,
                          sample.size = 19368); plants; p.rar

# we need to prepare our data for iNEXT. for doubts, refer to https://doi.org/10.17504/protocols.io.bu6fnzbn
# our data should be a species-by-samples matrix with incidence values, i.e. 
# 1 or 0 (presence or absence). species should be rows and samples be columns:

### by container
cont1 = subset_samples(p.rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(p.rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(cont1inext, 
              cont2inext)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 60,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage", 
                                "Container ", 
                                test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage", 
                                           "Container ", 
                                           test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage", 
                                               "Container ", 
                                               test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage", 
                              "Container ", 
                              test$AsyEst$Assemblage)

p1 <- ggiNEXT(test, type = 1, se = FALSE) +
  theme_bw() +
  ggtitle("All pots, one sample per pot") + 
  theme(legend.position = "right"); p1
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

p1 + annotate(geom = "text", x = 5, y = 15, hjust = 0, 
              label = insight::export_table(results), size = 4) -> p1; p1
###

### by container and host

cont1 = subset_samples(p.rar, container == "1"); cont1 = prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1tax = subset_samples(cont1, 
                          host == "Taxus"); cont1tax <- prune_taxa(taxa_sums(cont1tax)>0, cont1tax); cont1tax
cont1thu = subset_samples(cont1, 
                          host == "Thuja"); cont1thu <- prune_taxa(taxa_sums(cont1thu)>0, cont1thu); cont1thu
cont1taxinext = data.frame(t(cont1tax@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
cont1thuinext = data.frame(t(cont1thu@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))



cont2 = subset_samples(p.rar, container == "2"); cont2 = prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2tax = subset_samples(cont2, 
                          host == "Taxus")
cont2thu = subset_samples(cont2, 
                          host == "Thuja")
cont2taxinext = data.frame(t(cont2tax@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
cont2thuinext = data.frame(t(cont2thu@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

contshost <- list(cont1taxinext, 
                  cont1thuinext, 
                  cont2taxinext, 
                  cont2thuinext)

conts.out = iNEXT::iNEXT(contshost, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         se = TRUE
                         )

conts.out$DataInfo$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$AsyEst$Assemblage)

p2 <- ggiNEXT(conts.out, type = 1, se = FALSE) +
  theme_bw() + 
  ggtitle("All pots, one sample per pot") + 
  theme(legend.position = "right"); p2

results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

p2 + annotate(geom = "text", x = 5, y = 15, hjust = 0, 
              label = insight::export_table(results)) -> p2; p2
#





##### less vs more soil per sample

twice = subset_samples(plants, interval == "double"); twice
twice.m = merge_samples(twice, group = "pot_id"); twice.m 

# reassign sample data in twice.m:
twice.m@sam_data$pot_id = rownames(twice.m@sam_data) # fix pot_id variable
twice.m@sam_data$pot_id = sub("p","",twice.m@sam_data$pot_id) 
twice.m@sam_data$pot_id = as.numeric(twice.m@sam_data$pot_id) # this will let us sort by pot_id
twice.m.sam = data.frame(twice.m@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id))

# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(sample_id!="1_2") %>%
  filter(sample_id!="2_2") %>%
  filter(sample_id!="3_2") %>%
  filter(sample_id!="4_2") %>%
  filter(sample_id!="5_2")

# and reassign variables: 
twice.m.sam$host = sam$host
twice.m.sam$container = sam$container
twice.m.sam$interval = sam$interval

# convert til sample_data() object:
twice.m.sam = sample_data(twice.m.sam); sample_names(twice.m.sam)

# and reassign to twice.m phyloseq object: 
sample_data(twice.m) = twice.m.sam; twice.m; head(twice.m@sam_data)


# now we want to get the merged samples back in the original dataset. we first
# create a new dataset with only samples from pots sampled once: 
once = subset_samples(plants, interval == "single"); once

# and now we can merge the two phyloseq objects:
plants2 = merge_phyloseq(twice.m, once); plants2

sort(sample_sums(plants2))
p2rar = rarefy_even_depth(plants2, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = 14215); plants2; p2rar
View(p2rar@sam_data)


cont1 = subset_samples(p2rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, interval=="single"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, interval=="double"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(p2rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, interval=="single"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, interval=="double"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 60,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$AsyEst$Assemblage)

p3 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  ggtitle("Less vs. more soil per sample, both containers") + 
  #scale_color_manual(values = c("steelblue1", "hotpink2", "chartreuse3", "gold2")) +
  theme(legend.position = "right"); p3

#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

p3 + annotate(geom = "text", x = 5, y = 15, hjust = 0, 
              label = insight::export_table(results)) -> p3; p3
#

twice = subset_samples(plants, interval == "double"); twice = prune_taxa(taxa_sums(twice)>0,
                                                                         twice); twice
first = subset_samples(twice, grepl(pattern = "_1", 
                                    x = twice@sam_data$sample_id)); first = prune_taxa(taxa_sums(first)>0,
                                                                                       first); first
first@sam_data$turn = "first"; head(first@sam_data) # add a variable to distinguish between first and merged samples
second = merge_samples(twice, group = "pot_id"); second 

# reassign sample data in second:
second@sam_data$pot_id = rownames(second@sam_data) # fix pot_id variable
second@sam_data$pot_id = sub("p","", second@sam_data$pot_id) 
second@sam_data$pot_id = as.numeric(second@sam_data$pot_id) # this will let us sort by pot_id
second.sam = data.frame(second@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id)); head(second.sam); tail(second.sam)



# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(grepl(pattern = "_2", 
               sam$sample_id))

# and reassign variables: 
second.sam$host = sam$host
second.sam$container = sam$container
second.sam$interval = sam$interval
second.sam$turn = "second"; # add a variable to distinguish between merged and first samples

# convert til sample_data() object:
second.sam = sample_data(second.sam); sample_names(second.sam)

# and reassign to twice.m phyloseq object: 
sample_data(second) = second.sam; twice.m; head(second@sam_data)


# now we can merge the two phyloseq objects in order to normalize them:
fiphy = merge_phyloseq(first, second); fiphy

# normalize the new phyloseq object:
sort(sample_sums(fiphy)) # we can normalize at the lowest read depth to keep all samples and only lose two taxa:
fiphyrar = rarefy_even_depth(fiphy, 
                             rngseed = 123, 
                             replace = FALSE, 
                             trimOTUs = TRUE, 
                             sample.size = 10378); fiphy; fiphyrar
#

cont1 = subset_samples(fiphyrar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, turn=="first"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, turn=="second"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(fiphyrar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, turn=="first"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, turn=="second"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 200,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$AsyEst$Assemblage)

p4 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  ggtitle("Fold increase samples") + 
  #coord_cartesian(xlim = c(0, 50)) +
  theme(legend.position = "right"); p4
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

p4 + annotate(geom = "text", x = 5, y = 15, hjust = 0, 
              label = insight::export_table(results)) -> p4; p4
#
p.sacs <- ggarrange(p1,p2,p3,p4,nrow = 2,ncol = 2); p.sacs
```

FUNGI:

```{r}
library(iNEXT)

a <- subset_samples(fungi, sample_id!="1_2"); a
a <- subset_samples(a, sample_id!="2_2"); a
a <- subset_samples(a, sample_id!="3_2"); a
a <- subset_samples(a, sample_id!="4_2"); a
a <- subset_samples(a, sample_id!="5_2"); a
sort(sample_sums(a))
f.rar = rarefy_even_depth(a, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE,
                          sample.size = 213969); fungi; f.rar

# we need to prepare our data for iNEXT. for doubts, refer to https://doi.org/10.17504/protocols.io.bu6fnzbn
# our data should be a species-by-samples matrix with incidence values, i.e. 
# 1 or 0 (presence or absence). species should be rows and samples be columns:

### by container
cont1 = subset_samples(f.rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(f.rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(cont1inext, 
              cont2inext)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 60,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage", 
                                "Container ", 
                                test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage", 
                                           "Container ", 
                                           test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage", 
                                               "Container ", 
                                               test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage", 
                              "Container ", 
                              test$AsyEst$Assemblage)

f1 <- ggiNEXT(test, type = 1, se = FALSE) +
  theme_bw() +
  ggtitle("All pots, one sample per pot") + 
  theme(legend.position = "right"); f1
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()
###

### by container and host

cont1 = subset_samples(f.rar, container == "1"); cont1 = prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1tax = subset_samples(cont1, 
                          host == "Taxus"); cont1tax <- prune_taxa(taxa_sums(cont1tax)>0, cont1tax); cont1tax
cont1thu = subset_samples(cont1, 
                          host == "Thuja"); cont1thu <- prune_taxa(taxa_sums(cont1thu)>0, cont1thu); cont1thu
cont1taxinext = data.frame(t(cont1tax@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
cont1thuinext = data.frame(t(cont1thu@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))



cont2 = subset_samples(f.rar, container == "2"); cont2 = prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2tax = subset_samples(cont2, 
                          host == "Taxus")
cont2thu = subset_samples(cont2, 
                          host == "Thuja")
cont2taxinext = data.frame(t(cont2tax@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
cont2thuinext = data.frame(t(cont2thu@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

contshost <- list(cont1taxinext, 
                  cont1thuinext, 
                  cont2taxinext, 
                  cont2thuinext)

conts.out = iNEXT::iNEXT(contshost, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         se = TRUE
                         )

conts.out$DataInfo$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$AsyEst$Assemblage)

f2 <- ggiNEXT(conts.out, type = 1, se = FALSE) +
  theme_bw() + 
  ggtitle("All pots, one sample per pot") + 
  theme(legend.position = "right"); f2
#





##### less vs more soil per sample

twice = subset_samples(fungi, interval == "double"); twice
twice.m = merge_samples(twice, group = "pot_id"); twice.m 

# reassign sample data in twice.m:
twice.m@sam_data$pot_id = rownames(twice.m@sam_data) # fix pot_id variable
twice.m@sam_data$pot_id = sub("p","",twice.m@sam_data$pot_id) 
twice.m@sam_data$pot_id = as.numeric(twice.m@sam_data$pot_id) # this will let us sort by pot_id
twice.m.sam = data.frame(twice.m@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id))

# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(sample_id!="1_2") %>%
  filter(sample_id!="2_2") %>%
  filter(sample_id!="3_2") %>%
  filter(sample_id!="4_2") %>%
  filter(sample_id!="5_2")

# and reassign variables: 
twice.m.sam$host = sam$host
twice.m.sam$container = sam$container
twice.m.sam$interval = sam$interval

# convert til sample_data() object:
twice.m.sam = sample_data(twice.m.sam); sample_names(twice.m.sam)

# and reassign to twice.m phyloseq object: 
sample_data(twice.m) = twice.m.sam; twice.m; head(twice.m@sam_data)


# now we want to get the merged samples back in the original dataset. we first
# create a new dataset with only samples from pots sampled once: 
once = subset_samples(fungi, interval == "single"); once

# and now we can merge the two phyloseq objects:
fungi2 = merge_phyloseq(twice.m, once); fungi2

sort(sample_sums(fungi2))
f2rar = rarefy_even_depth(fungi2, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = 237829); fungi2; f2rar
View(f2rar@sam_data)


cont1 = subset_samples(f2rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, interval=="single"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, interval=="double"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(f2rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, interval=="single"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, interval=="double"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         endpoint = 200,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$AsyEst$Assemblage)

f3 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  ggtitle("Less vs. more soil per sample, both containers") + 
  theme(legend.position = "right"); f3
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()
#






##### using the fiphy samples

twice = subset_samples(fungi, interval == "double"); twice = prune_taxa(taxa_sums(twice)>0,
                                                                         twice); twice
first = subset_samples(twice, grepl(pattern = "_1", 
                                    x = twice@sam_data$sample_id)); first = prune_taxa(taxa_sums(first)>0,
                                                                                       first); first
first@sam_data$turn = "first"; head(first@sam_data) # add a variable to distinguish between first and merged samples
second = merge_samples(twice, group = "pot_id"); second 

# reassign sample data in second:
second@sam_data$pot_id = rownames(second@sam_data) # fix pot_id variable
second@sam_data$pot_id = sub("p","", second@sam_data$pot_id) 
second@sam_data$pot_id = as.numeric(second@sam_data$pot_id) # this will let us sort by pot_id
second.sam = data.frame(second@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id)); head(second.sam); tail(second.sam)



# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(grepl(pattern = "_2", 
               sam$sample_id))

# and reassign variables: 
second.sam$host = sam$host
second.sam$container = sam$container
second.sam$interval = sam$interval
second.sam$turn = "second"; # add a variable to distinguish between merged and first samples

# convert til sample_data() object:
second.sam = sample_data(second.sam); sample_names(second.sam)

# and reassign to twice.m phyloseq object: 
sample_data(second) = second.sam; twice.m; head(second@sam_data)


# now we can merge the two phyloseq objects in order to normalize them:
fiphy = merge_phyloseq(first, second); fiphy

# normalize the new phyloseq object:
sort(sample_sums(fiphy)) # we can normalize at the lowest read depth to keep all samples and only lose two taxa:
fiphyrar = rarefy_even_depth(fiphy, 
                             rngseed = 123, 
                             replace = FALSE, 
                             trimOTUs = TRUE, 
                             sample.size = 213969); fiphy; fiphyrar
#

cont1 = subset_samples(fiphyrar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, turn=="first"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, turn=="second"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(fiphyrar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, turn=="first"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, turn=="second"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 200,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$AsyEst$Assemblage)

f4 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  ggtitle("Fold increase samples") + 
  #coord_cartesian(xlim = c(0, 50)) +
  theme(legend.position = "right"); f4
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()
#

f.sacs <- ggarrange(f1,f2,f3,f4,nrow=2,ncol=2); f.sacs


```



########

### PLANT SACs comparing soil sample volume

```{r}

twice = subset_samples(plants, interval == "double"); twice
twice.m = merge_samples(twice, group = "pot_id"); twice.m 

# reassign sample data in twice.m:
twice.m@sam_data$pot_id = rownames(twice.m@sam_data) # fix pot_id variable
twice.m@sam_data$pot_id = sub("p","",twice.m@sam_data$pot_id) 
twice.m@sam_data$pot_id = as.numeric(twice.m@sam_data$pot_id) # this will let us sort by pot_id
twice.m.sam = data.frame(twice.m@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id))

# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(sample_id!="1_2") %>%
  filter(sample_id!="2_2") %>%
  filter(sample_id!="3_2") %>%
  filter(sample_id!="4_2") %>%
  filter(sample_id!="5_2")

# and reassign variables: 
twice.m.sam$host = sam$host
twice.m.sam$container = sam$container
twice.m.sam$interval = sam$interval

# convert til sample_data() object:
twice.m.sam = sample_data(twice.m.sam); sample_names(twice.m.sam)

# and reassign to twice.m phyloseq object: 
sample_data(twice.m) = twice.m.sam; twice.m; head(twice.m@sam_data)


# now we want to get the merged samples back in the original dataset. we first
# create a new dataset with only samples from pots sampled once: 
once = subset_samples(plants, interval == "single"); once

# and now we can merge the two phyloseq objects:
plants2 = merge_phyloseq(twice.m, once); plants2

sort(sample_sums(plants2))
p2rar = rarefy_even_depth(plants2, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = 14215); plants2; p2rar

View(p2rar@sam_data)


cont1 = subset_samples(p2rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, interval=="single"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, interval=="double"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(p2rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, interval=="single"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, interval=="double"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 60,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$AsyEst$Assemblage)

p3 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  ggtitle("Less vs. more soil per sample, both containers") + 
  theme(legend.position = "right"); p3
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()
###################################################################################



#### first vs. second per container

first = subset_samples(fiphyrar, turn == "first"); first <- prune_taxa(taxa_sums(first)>0, first); first
firstinext = data.frame(t(first@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))


first1 = subset_samples(first, container == "1"); first1 <- prune_taxa(taxa_sums(first1)>0, first1); first1
firstinext1 = data.frame(t(first1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

first2 = subset_samples(first, container == "2"); first2 <- prune_taxa(taxa_sums(first2)>0, first2); first2
firstinext2 = data.frame(t(first2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

second = subset_samples(fiphyrar, turn == "second"); second <- prune_taxa(taxa_sums(second)>0, second); second
secondinext = data.frame(t(second@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))


second1 = subset_samples(second, container == "1"); second1 <- prune_taxa(taxa_sums(second1)>0, second1); second1
secondinext1 = data.frame(t(second1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

second2 = subset_samples(second, container == "2"); second2 <- prune_taxa(taxa_sums(second2)>0, second2); second2
secondinext2 = data.frame(t(second2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))




conts <- list(firstinext1, firstinext2, secondinext1, secondinext2)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         se = TRUE, 
                         )
conts.out$DataInfo$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$AsyEst$Assemblage)


conts.out$DataInfo <- conts.out$DataInfo %>% 
  mutate(Assemblage=sub("assemblage1", "Less C1", Assemblage)) %>% 
  mutate(Assemblage=sub("assemblage2", "More C1", Assemblage)) %>% 
  mutate(Assemblage=sub("assemblage3", "Less C2", Assemblage)) %>%
  mutate(Assemblage=sub("assemblage4", "More C2", Assemblage)) 

conts.out$AsyEst %>% 
  data.frame() %>% 
  filter(Diversity=="Species richness") %>% print()

ggiNEXT(conts.out, type = 1, se = F) +
  theme_classic() +
  labs(title = "Fungi - less vs. more soil per sample") 
###

```





FUNGI

first normalize the number of sequences across samples:

```{r}
quantile(sample_sums(fungi)); sort(sample_sums(fungi))

# we have many more reads per sample for fungi than for plants. we can normalize
# at the lowest sampling depth to retain all samples and almost most taxa. 
f.rar = rarefy_even_depth(fungi, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE,
                          sample.size = min(sample_sums(fungi))); fungi; f.rar
```


model FUNGAL observed richness 


first we want to know which factors are important for the alpha diversity in each
individual soil sample. we therefore include all samples from all pots, and will
include pot_id as a random effect in our model to account for the fact that

FUNGI

first normalize the number of sequences across samples:

```{r}
quantile(sample_sums(fungi)); sort(sample_sums(fungi))

# we have many more reads per sample for fungi than for plants. we can normalize
# at the lowest sampling depth to retain all samples and almost most taxa. 
f.rar = rarefy_even_depth(fungi, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE,
                          sample.size = min(sample_sums(fungi))); fungi; f.rar
```


model FUNGAL observed richness 


first we want to know which factors are important for the alpha diversity in each
individual soil sample. we therefore include all samples from all pots, and will
include pot_id as a random effect in our model to account for the fact that

```{r}
# create a data.frame with observed richness and sampling data:
obs = cbind(data.frame(estimate_richness(f.rar,
                                         measures = "Observed"),
                       sample_data(f.rar))); str(obs)

# we do some plotting to explore the data:
obs %>% 
  ggplot(aes(x=container, y=Observed, 
             fill=host)) + 
  geom_boxplot()

# it seems like there is a difference in observed species richness between thuja
# and taxus in container 1 but not in container 2. this indicates an interaction 
# effect between container and host. 

# before fitting our data to a model, we need to figure out what distribution
# bets fits our data. we use the package fitdistrplus for this:
library(fitdistrplus) # load package

# we found it difficult to fit the data to a suitable distribution. by log
# transforming the data and dividing by 10, they're not significantly different 
# from a beta distribution:
plotdist(obs$Observed, 
         histo = TRUE, demp = TRUE) # when

descdist(obs$Observed, 
         boot = 1000) # skewness-kurtosis plot

x=fitdist(obs$Observed/751, 
          distr = "beta", 
          method = "mle"); summary(x); plot(x) 

gofstat(x) # not statistically significantly different from a gamma distribution. 


# fit a simple model to test:
library(glmmTMB)
library(effects)

fungi.model = glmmTMB(data = obs,
                      formula = log(Observed)/10 ~ container + host + (1|pot_id),
                      family = beta_family()); summary(fungi.model)
plot(allEffects(fungi.model))

library(DHARMa)
testDispersion(fungi.model)

simout = simulateResiduals(fungi.model, plot = F)
sort(residuals(simout))
plot(simout)
#
# make a pretty boxplot to go with the results: 
fmodbox1 <- obs %>% 
  ggplot(aes(x=container, y=Observed, 
             fill=container)) + 
  geom_boxplot(alpha = 0.75) +
  theme_classic() +
  scale_fill_manual(values = c("orange1", 
                               "orange4")) +
  theme(legend.title = element_blank(),
        legend.position = "none",
        legend.box.background = element_rect(colour = "black", 
                                             size = 1),
        legend.margin = margin(3, 3, 3, 3),
        axis.title.x = element_blank()) +
  ylab("Observed species richness") +
  labs(title = "Contaminant fungal richness", subtitle = "Containers"); fmodbox1

fmodbox2 <- obs %>% 
  ggplot(aes(x=host, y=Observed, 
             fill=host)) + 
  geom_boxplot(alpha = 0.75) +
  theme_classic() +
  scale_fill_manual(values = c("orange1", 
                               "orange4")) +
  theme(legend.title = element_blank(),
        legend.position = "none",
        legend.box.background = element_rect(colour = "black", 
                                             size = 1),
        legend.margin = margin(3, 3, 3, 3), 
        axis.title.x = element_blank()) +
  ylab(" ") +
  labs(title = " ", subtitle = "Host plants"); fmodbox2
fmodbox <- ggarrange(fmodbox1, fmodbox2, nrow = 1); fmodbox
##################

f <- obs %>% 
  ggplot(aes(y=Observed, x=container,
             fill=container)) +  
  theme_classic() +
  geom_boxplot(width=0.5, 
               outlier.shape = NA, 
               alpha=0.4) +
  scale_fill_manual(values = c("tan1",
                               "hotpink")) + 
#  scale_y_continuous(breaks = seq(0, 15, 3)) +
  theme(legend.title = element_blank(), 
        legend.position = c(0.85,0.85), 
        legend.background = element_rect(colour = "black",
                                         fill = "grey95"), 
        legend.text = element_text()) + 
  annotate(geom = "text", label = c("A", "B", "AB", "AB"),
           x = c(0.88, 1.12, 1.88, 2.12), 
           y = c(700, 550, 13.5, 9.5)); f

```





make extrapolated species accumulation curves

we're interested in approximating how many pots would have to be sampled per 
container to identify all contaminant species per container. we can extrapolate
based on our samples to get an estimate of this. we'll use the iNEXT package

PLANTS:

```{r}
library(iNEXT)

a <- subset_samples(plants, sample_id!="1_2"); a
a <- subset_samples(a, sample_id!="2_2"); a
a <- subset_samples(a, sample_id!="3_2"); a
a <- subset_samples(a, sample_id!="4_2"); a
a <- subset_samples(a, sample_id!="5_2"); a
sort(sample_sums(a))
p.rar = rarefy_even_depth(a, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE,
                          sample.size = 19368); plants; p.rar

# we need to prepare our data for iNEXT. for doubts, refer to https://doi.org/10.17504/protocols.io.bu6fnzbn
# our data should be a species-by-samples matrix with incidence values, i.e. 
# 1 or 0 (presence or absence). species should be rows and samples be columns:

### by container
cont1 = subset_samples(p.rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(p.rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(cont1inext, 
              cont2inext)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 60,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage", 
                                "Container ", 
                                test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage", 
                                           "Container ", 
                                           test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage", 
                                               "Container ", 
                                               test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage", 
                              "Container ", 
                              test$AsyEst$Assemblage)

p1 <- ggiNEXT(test, type = 1, se = FALSE) +
  theme_bw() +
  ggtitle("Containers") + 
  theme(legend.position = "right"); p1
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

p1 + annotate(geom = "text", x = 10, y = 15, hjust = 0, 
              label = insight::export_table(results), size = 3) -> p1; p1
###

### by container and host

cont1 = subset_samples(p.rar, container == "1"); cont1 = prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1tax = subset_samples(cont1, 
                          host == "Taxus"); cont1tax <- prune_taxa(taxa_sums(cont1tax)>0, cont1tax); cont1tax
cont1thu = subset_samples(cont1, 
                          host == "Thuja"); cont1thu <- prune_taxa(taxa_sums(cont1thu)>0, cont1thu); cont1thu
cont1taxinext = data.frame(t(cont1tax@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
cont1thuinext = data.frame(t(cont1thu@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))



cont2 = subset_samples(p.rar, container == "2"); cont2 = prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2tax = subset_samples(cont2, 
                          host == "Taxus")
cont2thu = subset_samples(cont2, 
                          host == "Thuja")
cont2taxinext = data.frame(t(cont2tax@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
cont2thuinext = data.frame(t(cont2thu@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

contshost <- list(cont1taxinext, 
                  cont1thuinext, 
                  cont2taxinext, 
                  cont2thuinext)

conts.out = iNEXT::iNEXT(contshost, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         se = TRUE
                         )

conts.out$DataInfo$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$AsyEst$Assemblage)

p2 <- ggiNEXT(conts.out, type = 1, se = FALSE) +
  theme_bw() + 
  ggtitle("Containers and hosts") + 
  theme(legend.position = "right"); p2

results <- data.frame(conts.out$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

p2 + annotate(geom = "text", x = 10, y = 15, hjust = 0, size = 3,
              label = insight::export_table(results)) -> p2; p2
#





##### less vs more soil per sample

twice = subset_samples(plants, interval == "double"); twice
twice.m = merge_samples(twice, group = "pot_id"); twice.m 

# reassign sample data in twice.m:
twice.m@sam_data$pot_id = rownames(twice.m@sam_data) # fix pot_id variable
twice.m@sam_data$pot_id = sub("p","",twice.m@sam_data$pot_id) 
twice.m@sam_data$pot_id = as.numeric(twice.m@sam_data$pot_id) # this will let us sort by pot_id
twice.m.sam = data.frame(twice.m@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id))

# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(sample_id!="1_2") %>%
  filter(sample_id!="2_2") %>%
  filter(sample_id!="3_2") %>%
  filter(sample_id!="4_2") %>%
  filter(sample_id!="5_2")

# and reassign variables: 
twice.m.sam$host = sam$host
twice.m.sam$container = sam$container
twice.m.sam$interval = sam$interval

# convert til sample_data() object:
twice.m.sam = sample_data(twice.m.sam); sample_names(twice.m.sam)

# and reassign to twice.m phyloseq object: 
sample_data(twice.m) = twice.m.sam; twice.m; head(twice.m@sam_data)


# now we want to get the merged samples back in the original dataset. we first
# create a new dataset with only samples from pots sampled once: 
once = subset_samples(plants, interval == "single"); once

twice.m <- twice # drop the merg entirely

# and now we can merge the two phyloseq objects:
plants2 = merge_phyloseq(twice.m, once); plants2

sort(sample_sums(plants))
p2rar = rarefy_even_depth(plants, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = 14215); plants2; p2rar
#View(p2rar@sam_data)


cont1 = subset_samples(p2rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, interval=="single"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, interval=="double"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(p2rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, interval=="single"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, interval=="double"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 60,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$AsyEst$Assemblage)

p3 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  labs(title = "Two vs. one sample per pot", 
       subtitle = "Plants") + 
  xlab("Sampled pots") +
  theme_classic() +
  scale_color_manual(values = c("chartreuse1", "chartreuse1",
                                "chartreuse4", "chartreuse4"), 
                     labels = c("C. 1 one sample", "C. 1 two samples", 
                          "C. 2 one sample", "C. 2 two samples")) +
  scale_shape_manual(values = c(21, 22, 21, 22),
                     labels = c("C. 1 one sample", "C. 1 two samples", 
                          "C. 2 one sample", "C. 2 two samples")) +
  theme(legend.position = c(0.85, 0.25), 
        legend.direction = "vertical", 
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15)) +
  ylab("Observed species richness") +
  xlab("Sampled pots"); p3
psac <- ggplot_build(p3)
psac$data[[1]]$size <- 5
psac$data[[1]]$stroke <- c(1,1,1,1)
psac$data[[1]]$colour <- c("black","black","black","black")
psac$data[[1]]$alpha <- c(0.75, 0.75, 0.75, 0.75)
psac$data[[1]]$fill <- c("chartreuse1", "chartreuse1",
                         "chartreuse4", "chartreuse4")
psac <- ggplot_gtable(psac)
gridExtra::grid.arrange(psac, fsac, nrow=1)
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

p3 + annotate(geom = "text", x = 10, y = 15, hjust = 0, size = 3,
              label = insight::export_table(results)) -> p3; p3
#

twice = subset_samples(plants, interval == "double"); twice = prune_taxa(taxa_sums(twice)>0,
                                                                         twice); twice
first = subset_samples(twice, grepl(pattern = "_1", 
                                    x = twice@sam_data$sample_id)); first = prune_taxa(taxa_sums(first)>0,
                                                                                       first); first
first@sam_data$turn = "first"; head(first@sam_data) # add a variable to distinguish between first and merged samples
second = merge_samples(twice, group = "pot_id"); second 

# reassign sample data in second:
second@sam_data$pot_id = rownames(second@sam_data) # fix pot_id variable
second@sam_data$pot_id = sub("p","", second@sam_data$pot_id) 
second@sam_data$pot_id = as.numeric(second@sam_data$pot_id) # this will let us sort by pot_id
second.sam = data.frame(second@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id)); head(second.sam); tail(second.sam)



# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(grepl(pattern = "_2", 
               sam$sample_id))

# and reassign variables: 
second.sam$host = sam$host
second.sam$container = sam$container
second.sam$interval = sam$interval
second.sam$turn = "second"; # add a variable to distinguish between merged and first samples

# convert til sample_data() object:
second.sam = sample_data(second.sam); sample_names(second.sam)

# and reassign to twice.m phyloseq object: 
sample_data(second) = second.sam; twice.m; head(second@sam_data)


# now we can merge the two phyloseq objects in order to normalize them:
fiphy = merge_phyloseq(first, second); fiphy

# normalize the new phyloseq object:
sort(sample_sums(fiphy)) # we can normalize at the lowest read depth to keep all samples and only lose two taxa:
fiphyrar = rarefy_even_depth(fiphy, 
                             rngseed = 123, 
                             replace = FALSE, 
                             trimOTUs = TRUE, 
                             sample.size = 10378); fiphy; fiphyrar
#

cont1 = subset_samples(fiphyrar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, turn=="first"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, turn=="second"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(fiphyrar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, turn=="first"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, turn=="second"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 200,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$AsyEst$Assemblage)

p4 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  ggtitle("More soil vs. less soil") + 
  #coord_cartesian(xlim = c(0, 50)) +
  theme(legend.position = "right"); p4
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

p4 + annotate(geom = "text", x = 10, y = 15, hjust = 0, size = 3,
              label = insight::export_table(results)) -> p4; p4
#
p.sacs <- ggarrange(p1,p2,p3,p4,nrow = 2,ncol = 2); p.sacs # 10 x 16
```

FUNGI:

```{r}
library(iNEXT)

a <- subset_samples(fungi, sample_id!="1_2"); a
a <- subset_samples(a, sample_id!="2_2"); a
a <- subset_samples(a, sample_id!="3_2"); a
a <- subset_samples(a, sample_id!="4_2"); a
a <- subset_samples(a, sample_id!="5_2"); a
sort(sample_sums(a))
f.rar = rarefy_even_depth(a, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE,
                          sample.size = 213969); fungi; f.rar

# we need to prepare our data for iNEXT. for doubts, refer to https://doi.org/10.17504/protocols.io.bu6fnzbn
# our data should be a species-by-samples matrix with incidence values, i.e. 
# 1 or 0 (presence or absence). species should be rows and samples be columns:

### by container
cont1 = subset_samples(f.rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(f.rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(cont1inext, 
              cont2inext)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 60,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage", 
                                "Container ", 
                                test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage", 
                                           "Container ", 
                                           test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage", 
                                               "Container ", 
                                               test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage", 
                              "Container ", 
                              test$AsyEst$Assemblage)

f1 <- ggiNEXT(test, type = 1, se = FALSE) +
  theme_bw() +
  ggtitle("Containers") + 
  theme(legend.position = "right"); f1
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

f1 + annotate(geom = "text", x = 10, y = 1000, hjust = 0, 
              label = insight::export_table(results), size = 3) -> f1; f1
###

### by container and host

cont1 = subset_samples(f.rar, container == "1"); cont1 = prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1tax = subset_samples(cont1, 
                          host == "Taxus"); cont1tax <- prune_taxa(taxa_sums(cont1tax)>0, cont1tax); cont1tax
cont1thu = subset_samples(cont1, 
                          host == "Thuja"); cont1thu <- prune_taxa(taxa_sums(cont1thu)>0, cont1thu); cont1thu
cont1taxinext = data.frame(t(cont1tax@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
cont1thuinext = data.frame(t(cont1thu@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))



cont2 = subset_samples(f.rar, container == "2"); cont2 = prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2tax = subset_samples(cont2, 
                          host == "Taxus")
cont2thu = subset_samples(cont2, 
                          host == "Thuja")
cont2taxinext = data.frame(t(cont2tax@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
cont2thuinext = data.frame(t(cont2thu@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

contshost <- list(cont1taxinext, 
                  cont1thuinext, 
                  cont2taxinext, 
                  cont2thuinext)

conts.out = iNEXT::iNEXT(contshost, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         se = TRUE
                         )

conts.out$DataInfo$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage1","Cont.1 Taxus", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage2","Cont.1 Thuja", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage3","Cont.2 Taxus", conts.out$AsyEst$Assemblage)

conts.out$DataInfo$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$DataInfo$Assemblage)
conts.out$iNextEst$size_based$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$iNextEst$size_based$Assemblage)
conts.out$iNextEst$coverage_based$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$iNextEst$coverage_based$Assemblage)
conts.out$AsyEst$Assemblage <- sub("assemblage4","Cont.2 Thuja", conts.out$AsyEst$Assemblage)

f2 <- ggiNEXT(conts.out, type = 1, se = FALSE) +
  theme_bw() + 
  ggtitle("Containers and hosts") + 
  theme(legend.position = "right"); f2

results <- data.frame(conts.out$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

f2 + annotate(geom = "text", x = 10, y = 1000, hjust = 0, 
              label = insight::export_table(results), size = 3) -> f2; f2
#





##### less vs more soil per sample

twice = subset_samples(fungi, interval == "double"); twice
twice.m = merge_samples(twice, group = "pot_id"); twice.m 

# reassign sample data in twice.m:
twice.m@sam_data$pot_id = rownames(twice.m@sam_data) # fix pot_id variable
twice.m@sam_data$pot_id = sub("p","",twice.m@sam_data$pot_id) 
twice.m@sam_data$pot_id = as.numeric(twice.m@sam_data$pot_id) # this will let us sort by pot_id
twice.m.sam = data.frame(twice.m@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id))

# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(sample_id!="1_2") %>%
  filter(sample_id!="2_2") %>%
  filter(sample_id!="3_2") %>%
  filter(sample_id!="4_2") %>%
  filter(sample_id!="5_2")

# and reassign variables: 
twice.m.sam$host = sam$host
twice.m.sam$container = sam$container
twice.m.sam$interval = sam$interval

# convert til sample_data() object:
twice.m.sam = sample_data(twice.m.sam); sample_names(twice.m.sam)

# and reassign to twice.m phyloseq object: 
sample_data(twice.m) = twice.m.sam; twice.m; head(twice.m@sam_data)


# now we want to get the merged samples back in the original dataset. we first
# create a new dataset with only samples from pots sampled once: 
once = subset_samples(fungi, interval == "single"); once

twice.m <- twice

# and now we can merge the two phyloseq objects:
fungi2 = merge_phyloseq(twice.m, once); fungi2

sort(sample_sums(fungi2))
f2rar = rarefy_even_depth(fungi, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = min(sample_sums(fungi))); fungi2; f2rar
View(f2rar@sam_data)


cont1 = subset_samples(f2rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, interval=="single"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, interval=="double"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(f2rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, interval=="single"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, interval=="double"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 200,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$AsyEst$Assemblage)

f3 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  ggtitle("Doubles vs. singles") + 
  theme(legend.position = "right"); f3
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

f3 + annotate(geom = "text", x = 10, y = 1000, hjust = 0, 
              label = insight::export_table(results), size = 3) -> f3; f3
#


f3 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  labs(title = " ", 
       subtitle = "Fungi") + 
  xlab("Sampled pots") +
  theme_classic() +
  scale_color_manual(values = c("orange1", "orange1",
                                "orange4", "orange4"), 
                     labels = c("C. 1 one sample", "C. 1 two samples", 
                          "C. 2 one sample", "C. 2 two samples")) +
  scale_shape_manual(values = c(21, 22, 21, 22),
                     labels = c("C. 1 one sample", "C. 1 two samples", 
                          "C. 2 one sample", "C. 2 two samples")) +
  theme(legend.position = c(0.85, 0.25), 
        legend.direction = "vertical",
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15)); p3
fsac <- ggplot_build(f3)
fsac$data[[1]]$size <- 5
fsac$data[[1]]$colour <- c("black","black","black","black")
fsac$data[[1]]$stroke <- c(1,1,1,1)
fsac$data[[1]]$alpha <- c(0.75, 0.75, 0.75, 0.75)
#fsac$data[[1]]$colour <- c("black", "black", "black", "black")
fsac$data[[1]]$fill <- c("orange1", "orange1",
                         "orange4", "orange4")
fsac <- ggplot_gtable(fsac)
grid.arrange(psac, fsac, nrow=1)
###########################





##### using the fiphy samples

twice = subset_samples(fungi, interval == "double"); twice = prune_taxa(taxa_sums(twice)>0,
                                                                         twice); twice
first = subset_samples(twice, grepl(pattern = "_1", 
                                    x = twice@sam_data$sample_id)); first = prune_taxa(taxa_sums(first)>0,
                                                                                       first); first
first@sam_data$turn = "first"; head(first@sam_data) # add a variable to distinguish between first and merged samples
second = merge_samples(twice, group = "pot_id"); second 

# reassign sample data in second:
second@sam_data$pot_id = rownames(second@sam_data) # fix pot_id variable
second@sam_data$pot_id = sub("p","", second@sam_data$pot_id) 
second@sam_data$pot_id = as.numeric(second@sam_data$pot_id) # this will let us sort by pot_id
second.sam = data.frame(second@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id)); head(second.sam); tail(second.sam)



# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(grepl(pattern = "_2", 
               sam$sample_id))

# and reassign variables: 
second.sam$host = sam$host
second.sam$container = sam$container
second.sam$interval = sam$interval
second.sam$turn = "second"; # add a variable to distinguish between merged and first samples

# convert til sample_data() object:
second.sam = sample_data(second.sam); sample_names(second.sam)

# and reassign to twice.m phyloseq object: 
sample_data(second) = second.sam; twice.m; head(second@sam_data)


# now we can merge the two phyloseq objects in order to normalize them:
fiphy = merge_phyloseq(first, second); fiphy

# normalize the new phyloseq object:
sort(sample_sums(fiphy)) # we can normalize at the lowest read depth to keep all samples and only lose two taxa:
fiphyrar = rarefy_even_depth(fiphy, 
                             rngseed = 123, 
                             replace = FALSE, 
                             trimOTUs = TRUE, 
                             sample.size = 213969); fiphy; fiphyrar
#

cont1 = subset_samples(fiphyrar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, turn=="first"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, turn=="second"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(fiphyrar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, turn=="first"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, turn=="second"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 200,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 more soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 less soil", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 more soil", test$AsyEst$Assemblage)

f4 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  ggtitle("More soil vs. less soil") + 
  #coord_cartesian(xlim = c(0, 50)) +
  theme(legend.position = "right"); f4
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

f4 + annotate(geom = "text", x = 10, y = 1000, hjust = 0, 
              label = insight::export_table(results), size = 3) -> f4; f4
#

f.sacs <- ggarrange(f1,f2,f3,f4,nrow=2,ncol=2); f.sacs # 10 x 16


```









### SACs comparing soil sample volume

```{r}

fiphyrar; table(fiphyrar@sam_data$turn)


#### first vs. second per container

first = subset_samples(fiphyrar, turn == "first"); first <- prune_taxa(taxa_sums(first)>0, first); first
firstinext = data.frame(t(first@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))


first1 = subset_samples(first, container == "1"); first1 <- prune_taxa(taxa_sums(first1)>0, first1); first1
firstinext1 = data.frame(t(first1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

first2 = subset_samples(first, container == "2"); first2 <- prune_taxa(taxa_sums(first2)>0, first2); first2
firstinext2 = data.frame(t(first2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

second = subset_samples(fiphyrar, turn == "second"); second <- prune_taxa(taxa_sums(second)>0, second); second
secondinext = data.frame(t(second@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))


second1 = subset_samples(second, container == "1"); second1 <- prune_taxa(taxa_sums(second1)>0, second1); second1
secondinext1 = data.frame(t(second1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

second2 = subset_samples(second, container == "2"); second2 <- prune_taxa(taxa_sums(second2)>0, second2); second2
secondinext2 = data.frame(t(second2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))




conts <- list(firstinext1, firstinext2, secondinext1, secondinext2)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         se = TRUE, 
                         )
conts.out$DataInfo <- conts.out$DataInfo %>% 
  mutate(Assemblage=sub("assemblage1", "Less C1", Assemblage)) %>% 
  mutate(Assemblage=sub("assemblage2", "More C1", Assemblage)) %>% 
  mutate(Assemblage=sub("assemblage3", "Less C2", Assemblage)) %>%
  mutate(Assemblage=sub("assemblage4", "More C2", Assemblage)) 

conts.out$AsyEst %>% 
  data.frame() %>% 
  filter(Diversity=="Species richness") %>% print()

ggiNEXT(conts.out, type = 1, se = F) +
  theme_classic() +
  labs(title = "Fungi - less vs. more soil per sample") 
###

```





```{r}
p.rar

plot_ordination(f.rar, 
                ordinate(f.rar, 
                         method = "PCoA", 
                         distance = "bray"), 
                color = "container", 
                shape = "host") +
  geom_point(size = 3) +
  stat_ellipse()


```







2. next we want to calculate the fold increase in species richness per pot when
increasing from one to two samples. to do this we will only use data from pots
sampled twice. FI = fold increase, S = sample, Obs = observed species richness:
FI = (Obs S1 + Obs S2) / Obs S1

```{r}
twice = subset_samples(plants, interval == "double"); twice = prune_taxa(taxa_sums(twice)>0,
                                                                         twice); twice
first = subset_samples(twice, grepl(pattern = "_1", 
                                    x = twice@sam_data$sample_id)); first = prune_taxa(taxa_sums(first)>0,
                                                                                       first); first
first@sam_data$turn = "first"; head(first@sam_data) # add a variable to distinguish between first and merged samples
second = merge_samples(twice, group = "pot_id"); second 

# reassign sample data in second:
second@sam_data$pot_id = rownames(second@sam_data) # fix pot_id variable
second@sam_data$pot_id = sub("p","", second@sam_data$pot_id) 
second@sam_data$pot_id = as.numeric(second@sam_data$pot_id) # this will let us sort by pot_id
second.sam = data.frame(second@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id)); head(second.sam); tail(second.sam)



# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(grepl(pattern = "_2", 
               sam$sample_id))

# and reassign variables: 
second.sam$host = sam$host
second.sam$container = sam$container
second.sam$interval = sam$interval
second.sam$turn = "second"; # add a variable to distinguish between merged and first samples

# convert til sample_data() object:
second.sam = sample_data(second.sam); sample_names(second.sam)

# and reassign to twice.m phyloseq object: 
sample_data(second) = second.sam; twice.m; head(second@sam_data)


# now we can merge the two phyloseq objects in order to normalize them:
fiphy = merge_phyloseq(first, second); fiphy

# normalize the new phyloseq object:
sort(sample_sums(fiphy)) # we can normalize at the lowest read depth to keep all samples and only lose two taxa:
fiphyrar = rarefy_even_depth(fiphy, 
                             rngseed = 123, 
                             replace = FALSE, 
                             trimOTUs = TRUE, 
                             sample.size = 10378); fiphy; fiphyrar

# now we have to separate the new object into two dataframes before we combine
# them to calculate and plot fold increase: 
first = subset_samples(fiphyrar, turn=="first")
first.df = data.frame(cbind(estimate_richness(first, 
                                              measures = "Observed"),
                            first@sam_data)) %>% 
  rename("obs_first"="Observed",
         "pot_id_first"="pot_id",
         "turn_first"="turn") %>% 
  mutate(pot_id=pot_id_first); head(first.df)

second = subset_samples(fiphyrar, turn=="second")
second.df = data.frame(cbind(estimate_richness(second, 
                                              measures = "Observed"),
                            second@sam_data)) %>% 
  rename("obs_second"="Observed",
         "pot_id_second"="pot_id",
         "turn_second"="turn") %>% 
  mutate(pot_id=pot_id_second); head(second.df)

fidf = full_join(first.df, second.df, by = c("pot_id", 
                                             "container", 
                                             "host")) %>% 
  select("obs_first", "obs_second", 
         "pot_id", "pot_id_first", "pot_id_second", 
         "turn_first", "turn_second", 
         "container","host"); head(fidf)

fidf = fidf %>% 
  mutate(foldincrease = obs_second/obs_first)
fig3.b.p=ggplot(fidf, aes(x=reorder(pot_id, -foldincrease), 
                 y=foldincrease,
                 fill=host, color=host)) + 
  geom_col(width=1) +
  scale_fill_manual(values = c("darkolivegreen1", 
                               "darkgreen")) +
  scale_color_manual(values = rep("black", 
                                  times=length(unique(fidf$host)))) +
  theme_classic() +
  theme(#legend.position = "none", 
        axis.ticks.x = element_blank()
      ) + 
  ylab("Fold increase") +
  xlab("Sampled pots") +
  scale_x_discrete(labels = paste0(rep(" ", times=20))) +
  labs(title = "B.",
       subtitle = "Plants") +
  annotate(geom = "text", 
           x=5, 
           y=2.5, 
           label = paste0("Median = ", 
                         round(median(fidf$foldincrease), 
                               digits = 2)), 
           fontface = "italic", 
           size=3, 
           color="black", 
           hjust=0) +
  scale_y_continuous(breaks = seq(0, 3, 0.5), limits = c(0, 3)) + 
  coord_cartesian(ylim = c(0.9, 3)) +
  facet_grid(.~container, scales = "free_x"); fig3.b.p

# additionally, we will investigate whether there is a correlation between 
# the richness in the second sample and fold increase for each pot:
cormod = cor.test(fidf$foldincrease, fidf$obs_second, 
         method = "pearson")
fig3.c.p=ggplot(fidf, aes(x=obs_second, 
                 y=foldincrease,
                 fill="darkolivegreen1")) + 
  theme_classic() +
  theme(legend.position = "none", 
        ) +
  scale_color_manual(values = "black") + 
  scale_fill_manual(values = "darkolivegreen1") +
  geom_point(size=6, pch=21) + 
  geom_smooth(method = "lm", 
              color="black", 
              fill="grey90") +
  scale_x_continuous(breaks = seq(0, 20, 5)) +
  scale_y_continuous(breaks = seq(0, 4, 0.5), 
                    limits = c(0, 3.6)) +
  xlab("Richness in both samples") +
  ylab("\nFold increase") + 
  labs(title = "C.",
       subtitle = "Plants") +
  coord_cartesian(ylim = c(1,3)) + 
  annotate(geom = "text", 
           x=8.8, 
           y=2.8, 
           label = paste0("r = ", 
                          round(cormod$estimate, 
                                digits = 3),
                          "\nP = ",
                          round(cormod$p.value,
                                digits = 3)), 
           fontface = "italic", size=3, color="black", 
           hjust = 0); fig3.c.p


```



venn diagrams

```{r}
library(MicEco)
cont1 <- subset_samples(p.rar, container=="1")
cont1venn <- ps_venn(ps = cont1, weight = T, relative = F,
        group = "host", 
        fill = list(fill=c("darkolivegreen1",
                           "darkolivegreen", 
                           "steelblue1"), 
                    alpha=0.75),
        quantities = list(type = c('counts',"percent")),
        main = expression("Plants in container 1")); plot(cont1venn)

cont2 <- subset_samples(p.rar, container=="2")
cont2venn <- ps_venn(ps = cont2, weight = T, relative = F,
        group = "host", 
        fill = list(fill=c("darkolivegreen1",
                           "darkolivegreen", 
                           "steelblue1"), 
                    alpha=0.75),
        quantities = list(type = c('counts',"percent")),
        main = expression("Plants in container 2")); plot(cont2venn)

plant.euler <- gridExtra::grid.arrange(cont1venn, cont2venn, 
                                       widths = c(1, 1), nrow = 1)

p.rar@sam_data$cont_host <- paste0("Container ",
                                   p.rar@sam_data$container, 
                                   "\n",
                                   p.rar@sam_data$host)
p.rar@sam_data$cont_host <- paste0("Cont. ",
                                   p.rar@sam_data$container, 
                                   "\n",
                                   p.rar@sam_data$host)
plantvenn <- ps_venn(ps = p.rar, 
                     weight = T, 
                     relative = F, 
                     group = "cont_host",
                     fill = list(fill=c("darkolivegreen1",
                                        "darkolivegreen",
                                        "darkolivegreen1",
                                        "darkolivegreen"), 
                     alpha=0.75),
                     main = expression("Unique and shared plants")); plantvenn
plantsab <- gridExtra::grid.arrange(pmodbox, plantvenn, nrow=1) # 8.27 x 4.25
#
###
cont1 <- subset_samples(p.rar, container=="1")
fungicont <- ps_venn(ps = cont1, weight = T, relative = F,
        group = "host", 
        fill = list(fill=c("orange1",
                           "tan", 
                           "hotpink1"), 
                    alpha=0.75),
        labels = list(labels = c("Container 1",
                                 "Container 2")),
        quantities = list(type = c('counts',"percent")),
        main = expression("Fungi by container")); plot(fungicont)

cont2 <- subset_samples(p.rar, container=="2")
fungihost <- ps_venn(ps = f.rar, weight = T, relative = F,
        group = "host", shape = "ellipse", 
        fill = list(fill=c("orange1",
                           "tan", 
                           "hotpink1"), 
                    alpha=0.75),
        quantities = list(type = c('counts',"percent")),
        main = expression("Fungi by host")); plot(fungihost)

f.rar@sam_data$cont_host <- paste0("Cont. ",
                                   f.rar@sam_data$container, 
                                   "\n",
                                   f.rar@sam_data$host)
fungivenn <- ps_venn(ps = f.rar, 
                     weight = F, 
                     relative = F, 
                     group = "cont_host",
                     fill = list(fill=c("orange1",
                                        "orange4",
                                        "orange1",
                                        "orange4"), 
                     alpha=0.75),
                     main = expression("Unique and shared fungi")); fungivenn
fungiab <- gridExtra::grid.arrange(fmodbox, fungivenn, nrow=1) # 8.27 x 4.25
#
gridExtra::grid.arrange(plantsab, NULL, fungiab, nrow=3, heights = c(1, 0.2, 1)) # 6 x 9
#

#####################################
```






```{r}

p2rar = rarefy_even_depth(plants2, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = 21915); plants2; p2rar

# now we're ready to have a look at observed species richness:
# make a dataframe for ease of testing and plotting:

obs.df = data.frame(cbind(estimate_richness(p2rar, 
                                            measures = "Observed"), 
                          sample_data(p2rar))); str(obs.df)

ggplot(obs.df, aes(x=host, y=Observed, fill=interval)) + 
  geom_boxplot() +
  facet_wrap(~container)


#hist(obs.df$Observed); shapiro.test(obs$Observed)
library(mosaic)
mod <- lm(Observed ~ interval * host * container, 
          data = obs.df); summary(mod); tuk <- TukeyHSD(mod); tuk$`interval:host:container`

data.frame(tuk$`interval:host:container`) %>% 
  filter(p.adj < 0.051) %>% 
  print()

volplants <- ggplot(obs.df, aes(x=interval, y=Observed, fill=host)) + 
  geom_boxplot() +
  theme_classic() + 
  scale_fill_manual(values = c("darkolivegreen1", 
                               "darkolivegreen4",
                               "darkolivegreen1",
                               "darkolivegreen4")) +
  annotate(geom = "text", 
           label = c("A","B","AB","B"), 
           x = c(0.8, 1.2, 1.8, 2.2), 
           y = c(16, 10, 12, 11)) +
  labs(title = "Sampling volume", 
       subtitle = "Plants"); volplants


##########
obs.df = data.frame(cbind(estimate_richness(f2rar, 
                                            measures = "Observed"), 
                          sample_data(f2rar))); str(obs.df)

volfun <- ggplot(obs.df, aes(x=interval, y=Observed, fill=interval)) + 
  geom_boxplot() + 
  theme_classic() + 
  scale_fill_manual(values = c("orange4", "orange1")) +
  annotate(geom = "text", 
           label = c("A", "B"), 
           x = c(1, 2), 
           y = c(980, 800)) +
  labs(title = " ", 
       subtitle = "Fungi")
ggarrange(volplants, volfun, nrow = 1)
#

#hist(obs.df$Observed); shapiro.test(obs$Observed)
library(mosaic)
mod <- lm(Observed ~ interval, 
          data = obs.df); summary(mod); tuk <- TukeyHSD(mod)

data.frame(tuk$interval) %>% 
  filter(p.adj < 0.055) %>% 
  print()


```




```{r}

fidf

library(mosaic)
mod <- lm(foldincrease ~ container + host, 
          data = fidf); summary(mod); tuk <- TukeyHSD(mod)

data.frame(tuk$container) 
```

