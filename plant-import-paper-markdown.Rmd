---
title: "plant-import-paper-r-markdown"
author: "pgfarsund"
date: "2023"
output: github_document
---

this markdown document contains code for the analysis and results already implemented 
in the manuscript for "the plant import paper" (in prep for Biological Invasions). in 
addition the these results, another script ("additional-analyses-for-the-plant-import-paper") 
contains analyses of the same data that have not (yet) been implemented in the manuscript.

```{r}
library(phyloseq)
library(tidyverse)
library(ggpubr)
```


load and manipulate phyloseq objects:
```{r}
### plants

# load data:
plants = readRDS(file = "plants-phyloseq-object.RDS") # change the path to data's location on your computer.

# manipulate the sample data:
sam = data.frame(plants@sam_data) %>% 
  dplyr::select("sample","Location_name",            # there is a lot of data we don't need.
                "Specific_host",
                "Sample_ID") %>% 
  rename(c("container"="Location_name",              # rename columns for simplicity.
           "host"="Specific_host", 
           "sample_id"="Sample_ID")) %>% 
  mutate(sample=sub("PLANTEIMP_21_", "", sample),    # easier to interpret sample number.
         sample=sub("_ITS_S2_ITS4", "", sample)) %>% 
  mutate(container = sub("Bil ", "", container)) %>% # remove "Bil " from the container ID.
  mutate(pot_id = c(rep(paste0("p", 1:5), each=2),   # add an ID to each pot - this will be
                    rep(paste0("p", 6:15), each=1),  # identical between samples taken from
                    rep(paste0("p", 16:20), each=2), # the same pot.
                    rep(paste0("p", 21:30), each=1),
                    rep(paste0("p", 31:35), each=2),
                    rep(paste0("p", 36:45), each=1),
                    rep(paste0("p", 46:50), each=2),
                    rep(paste0("p", 51:60), each=1))) %>%
  mutate(interval = c(rep("double", times=10),
                      rep("single", times=10),
                      rep("double", times=10),
                      rep("single", times=10),
                      rep("double", times=10),
                      rep("single", times=10), 
                      rep("double", times=10),
                      rep("single", times=10))); str(sam) 
sample_data(plants) = sample_data(sam); rm(sam); plants

# for this study we're only interested in vascular plants. our data set contains
# some bryophytes and green algae, additionally we're not interested in Taxus sp. 
# or Thuja sp., because these were ornamentals in the sampled soil. 
# remove non-focal taxa:
plants=subset_taxa(plants, phylum=="Streptophyta")
plants=subset_taxa(plants, class!="Chlorophyceae")
plants=subset_taxa(plants, order!="Splachnales")
plants=subset_taxa(plants, order!="Bryales")
plants=subset_taxa(plants, order!="Dicranales")
plants=subset_taxa(plants, order!="Funariales")
plants=subset_taxa(plants, order!="Hypnales")
plants=subset_taxa(plants, order!="Klebsormidiaceae")
plants=subset_taxa(plants, order!="Pottiales")
plants=subset_taxa(plants, order!="Pseudoditrichales")
plants=subset_taxa(plants, species!="Thuja_sp.")
plants=subset_taxa(plants, species!="Thuja_occidentalis")
plants=subset_taxa(plants, species!="Taxus_sp.")
plants=subset_taxa(plants, species!="Taxus_canadensis"); plants



### fungi

# load data:
fungi = readRDS(file = "fungi-phyloseq-object.RDS") # change the path to data's location on your computer
fungi = subset_samples(fungi, negative_control=="FALSE")

# manipulate the sample data:
sam = data.frame(fungi@sam_data) %>% 
  dplyr::select("sample","Location_name",            # there is a lot of data we don't need
                "Specific_host",
                "Sample_ID") %>%
  rename(c("container"="Location_name",              # rename columns for simplicity
           "host"="Specific_host", 
           "sample_id"="Sample_ID")) %>% 
  mutate(sample=sub("PLANTEIMP_21_", "", sample),    # easier to interpret sample number
         sample=sub("_fITS7_ITS4", "", sample)) %>% 
  mutate(container = sub("Bil ", "", container)) %>% # remove "Bil " from the container ID
  mutate(pot_id = c(rep(paste0("p", 1:5), each=2),   # add an ID to each pot - this will be
                    rep(paste0("p", 6:15), each=1),  # identical between samples taken from
                    rep(paste0("p", 16:20), each=2), # the same pot
                    rep(paste0("p", 21:30), each=1),
                    rep(paste0("p", 31:35), each=2),
                    rep(paste0("p", 36:45), each=1),
                    rep(paste0("p", 46:50), each=2),
                    rep(paste0("p", 51:60), each=1))) %>%
  mutate(interval = c(rep("double", times=10),
                      rep("single", times=10),
                      rep("double", times=10),
                      rep("single", times=10),
                      rep("double", times=10),
                      rep("single", times=10), 
                      rep("double", times=10),
                      rep("single", times=10)))
sample_data(fungi) = sample_data(sam); rm(sam); fungi
```


##### RESULTS

### contaminant plants and fungi ### (Fig. 1)

we identified many contaminant plants and fungi that were native, known aliens, 
and potential alien species to Norway. we've grouped these species as "Native", 
"Alien", "Swe., Fin., Den." (i.e. native to Norway's neighboring countries), 
(native to) "Europe", and (native to) "Non-Europe". we will make a stacked bar
chart to show the relative frequencies of these different categories:

```{r}

# build the data frame:
df = data.frame("freq" = c(30.30, 45.45, 0, 12.12, 12.12, 0, # start with plant frequencies
                           39.53, 0.81, 22.32, 22.89, 10.88, 3.57), # then fungal frequencies
                "group" = rep(c("Plants",
                                "Fungi"), each=6),
                "cats" = c(rep(c("Native",
                                 "Alien",
                                 "Swe., Fin., Den.",
                                 "Europe", 
                                 "Non-Europe",
                                 "NA"), times=2)))

# make Figure 1 in the manuscript:
fig.1 = df %>%
ggplot(aes(x=factor(group, 
                    level=c("Plants",
                            "Fungi")), # order the groups on the x-axis
           y=freq, 
           fill=factor(cats, 
                       levels = c("Native", # we want the stacked bars to have this specific order
                                  "Alien", 
                                  "Swe., Fin., Den.",
                                  "Europe", 
                                  "Non-Europe", 
                                  "NA")),
           color=factor(cats, 
                        levels = c("Native", 
                                   "Alien", 
                                   "Swe., Fin., Den.",
                                   "Europe", 
                                   "Non-Europe", 
                                   "NA")))) + 
  geom_col(position = "fill", 
           width = 0.55) + 
  theme_classic(base_size = 15) +
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", # some nice colors to fill the bars
                               "#F0E442", "#CC79A7", "#999999")) +
  scale_color_manual(values = rep("black", times = 6)) +
  theme(legend.position = "right") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank()) +
  annotate(geom = "text", 
           label = c("30.3 %", 
                     "45.5 %",
                     "12.1 %",
                     "12.1 %", 
                     "39.5 %",
                     "0.8 %",
                     "22.3 %", 
                     "22.9 %", 
                     "10.9 %",
                     "3.6 %"),
           x = rep(c(1,
                     2,
                     2.45,
                     2,
                     2.45), # we want "0.8 %" and "3.6 %" outside the actual bar, which makes this a bit tricky
                   times = c(4,
                             1,
                             1,
                             3,
                             1)), 
           y = c(0.84, 0.45, 0.18, 0.06, # plant percent labels
                 0.8, 0.6, 0.5, 0.26, 0.1, 0.02), # fungi percent labels
           size = 4, color = "black", fontface = 1) + 
  annotate(geom = "segment", 
           x = rep(2.25,
                   times=2), 
           xend = rep(2.315, 
                      times=2), 
           y = c(0.60,
                 0.02), 
           yend = c(0.60,
                    0.02)) + 
  scale_y_continuous(labels = scales::percent); fig.1 # save as .pdf landscape 5 x 6

```


### metabarcoding vs. germination ### (Fig. 2)

we identified 33 plant species with metabarcoding and 30 with germination. five 
species were identified by both methods, adding up to 58 contaminant plant species
identified all together. we also checked whether identified plants were registered 
as products in the online assortments of Noviflora and Plantasjen in the fall of 
2021 (the year of sampling). we will make two stacked bar charts to show how many 
species fall into each category, while also showing how many species were identified
with metabarcoding, germination, or both: 

```{r}
df2 = read.csv(file = "C:/Users/pgfar/Dropbox/Whats_in_the_pot/plant-import-paper/fig_2_dataset.csv",
               sep = ";"); str(df2) # change path 

my_colors = c("#CC79A7",
              "#009E73",
              "#E69F00")

a = df2 %>% 
  mutate(prev_det=sub("TRUE", "Yes", prev_det)) %>% 
  mutate(prev_det=sub("FALSE", "No", prev_det)) %>% 
  ggplot(aes(x=factor(prev_det, 
                             levels = c("Yes", 
                                        "No")),
                color=factor(id_method,
                             levels = c("Metabarcoding",
                                        "Germination",
                                        "Both")),
                fill=factor(id_method,
                            levels = c("Metabarcoding",
                                       "Germination",
                                       "Both")))) + 
  geom_bar(position = "stack",
           width = 0.55) +
  scale_fill_manual(values = my_colors) +
  scale_color_manual(values = rep("black", times=3)) +
  theme_classic(base_size = 15) + 
  xlab("Previously identified?") + 
  ylab("Number of plant species") + 
  labs(fill = "Identification\nmethod", 
       color = "Identification\nmethod", 
       subtitle = "a.") +
  theme(legend.title = element_text(size = 13)) +
  scale_y_continuous(breaks = seq(0, 45, 10), 
                     limits = c(0, 45)); a

b = df2 %>% 
  mutate(ornamental=sub("TRUE", "Yes", ornamental)) %>% 
  mutate(ornamental=sub("FALSE", "No", ornamental)) %>% 
  ggplot(aes(x=factor(ornamental, 
                             levels = c("Yes", 
                                        "No")),
                color=factor(id_method,
                           levels = c("Metabarcoding",
                                      "Germination",
                                      "Both")),
                fill=factor(id_method,
                           levels = c("Metabarcoding",
                                      "Germination",
                                      "Both")))) + 
  geom_bar(position = "stack",
           width = 0.55) +
  scale_fill_manual(values = my_colors) +
  scale_color_manual(values = rep("black", times=3)) +
  theme_classic(base_size = 15) + 
  xlab("Ornamental?") + 
  ylab(" ") + 
  labs(fill = "Identification\nmethod", 
       color = "Identification\nmethod", 
       subtitle = "b.") +
  theme(legend.title = element_text(size = 13)) +
  scale_y_continuous(breaks = seq(0, 55, 10), 
                     limits = c(0, 45)); b

fig.2 = ggarrange(a, b, 
                    common.legend = TRUE,
                    legend = "right", 
                    nrow = 1); fig.2

```


### effect of sampling strategy on contaminant species richness ### (Fig. 3)

we want to investigate the effect of sampling effort on the observed species 
richness of contaminant plants and fungi identified by metabarcoding. we'll do
this in two steps:

1. we want to compare contaminant species detection between two sampling 
strategies for obtaining 20 samples per container: to sample 20 different pots
once, or sample 10 different pots twice. we're interested in 1) the total number
of species identified by both strategies, and 2) estimates of total richness 
based on the two strategies:

```{r}
library(iNEXT)

##### road to 20 --- one per 20 vs. two per 10
sort(sample_sums(plants))
p2rar = rarefy_even_depth(plants, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = 21915); plants2; p2rar

# to run iNEXT, we need a list of objects to interpolate/extrapolate richness in. 
# we want one curve for each sampling effort per container, for four curves in all. 
# start by subsetting containers and sampling efforts: 

cont1 = subset_samples(p2rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, interval=="single"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, interval=="double"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(p2rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, interval=="single"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, interval=="double"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out.p <- iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 60,
                         se = TRUE
                         )
inext.res.p <- conts.out.p

# we should fix the names of our assemblages to match our dataset: 
inext.res.p$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 one/pot", inext.res.p$DataInfo$Assemblage)
inext.res.p$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 one/pot", inext.res.p$iNextEst$size_based$Assemblage)
inext.res.p$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 one/pot", inext.res.p$iNextEst$coverage_based$Assemblage)
inext.res.p$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 one/pot", inext.res.p$AsyEst$Assemblage)

inext.res.p$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 two/pot", inext.res.p$DataInfo$Assemblage)
inext.res.p$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 two/pot", inext.res.p$iNextEst$size_based$Assemblage)
inext.res.p$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 two/pot", inext.res.p$iNextEst$coverage_based$Assemblage)
inext.res.p$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 two/pot", inext.res.p$AsyEst$Assemblage)

inext.res.p$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 one/pot", inext.res.p$DataInfo$Assemblage)
inext.res.p$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 one/pot", inext.res.p$iNextEst$size_based$Assemblage)
inext.res.p$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 one/pot", inext.res.p$iNextEst$coverage_based$Assemblage)
inext.res.p$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 one/pot", inext.res.p$AsyEst$Assemblage)

inext.res.p$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 two/pot", inext.res.p$DataInfo$Assemblage)
inext.res.p$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 two/pot", inext.res.p$iNextEst$size_based$Assemblage)
inext.res.p$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 two/pot", inext.res.p$iNextEst$coverage_based$Assemblage)
inext.res.p$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 two/pot", inext.res.p$AsyEst$Assemblage)
inext.res.p$DataInfo$container <- c("1","1","2","2")

# finally we plot our curves: 
p3 <- ggiNEXT(inext.res.p, type = 1, se = F) +
  theme_classic(base_size = 15) +
  scale_color_manual(values = c("chartreuse1", "chartreuse1",
                                "chartreuse4", "chartreuse4"), 
                     labels = c("C. 1 one sample", "C. 1 two samples", 
                          "C. 2 one sample", "C. 2 two samples")) +
  scale_shape_manual(values = c(21, 22, 21, 22),
                     labels = c("C. 1 one sample", "C. 1 two samples", 
                          "C. 2 one sample", "C. 2 two samples")) +
  theme(#legend.position = c(0.85, 0.25), legend.direction = "vertical", 
        legend.position = "right", legend.direction = "vertical",
        #guides(color = guide_legend(nrow = 2)),
        axis.text.x = element_text(),
        axis.text.y = element_text(),
        axis.title.x = element_text(),
        axis.title.y = element_text()) +
  ylab("Species richness") +
  labs(title = "Plants") + 
  xlab("Sampled pots"); p3
psac <- ggplot_build(p3)
psac$data[[1]]$size <- 7
psac$data[[1]]$stroke <- c(1,1,1,1)
psac$data[[1]]$colour <- c("black","black","black","black")
psac$data[[1]]$alpha <- c(0.75, 0.75, 0.75, 0.75)
psac$data[[1]]$fill <- c("chartreuse1", "chartreuse1",
                         "chartreuse4", "chartreuse4")
psac <- ggplot_gtable(psac); plot(psac)
#
results <- data.frame(inext.res.p$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

p3 + annotate(geom = "text", x = 10, y = 15, hjust = 0, size = 3,
              label = insight::export_table(results)) -> p3; p3

```


2. we want to know whether a larger volume of soil per sample had an effect on 
the observed species richness per pot. unfortunately, all samples consisted of 
approximately 25 grams. we're therefore going to simulate doubling the soil sample 
volume by merging samples that were taken from the same same pot, prior to 
normalizing the read counts across all samples:

```{r}

# we're going to merge samples from the same pots. to do this, we first create a 
# new phyloseq object with only the samples we're going to merge: 
twice = subset_samples(plants, interval == "double"); twice
twice.m = merge_samples(twice, group = "pot_id"); twice.m 

# reassign sample data in twice.m:
twice.m@sam_data$pot_id = rownames(twice.m@sam_data) # fix pot_id variable
twice.m@sam_data$pot_id = sub("p","",twice.m@sam_data$pot_id) 
twice.m@sam_data$pot_id = as.numeric(twice.m@sam_data$pot_id) # this will let us sort by pot_id
twice.m.sam = data.frame(twice.m@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id))

# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(sample_id!="1_2") %>%
  filter(sample_id!="2_2") %>%
  filter(sample_id!="3_2") %>%
  filter(sample_id!="4_2") %>%
  filter(sample_id!="5_2")

# and reassign variables: 
twice.m.sam$host = sam$host
twice.m.sam$container = sam$container
twice.m.sam$interval = sam$interval

# convert til sample_data() object:
twice.m.sam = sample_data(twice.m.sam); sample_names(twice.m.sam)

# and reassign to twice.m phyloseq object: 
sample_data(twice.m) = twice.m.sam; twice.m; head(twice.m@sam_data)


# now we want to get the merged samples back in the original dataset. we first
# create a new dataset with only samples from pots sampled once: 
once = subset_samples(plants, interval == "single"); once

# and now we can merge the two phyloseq objects:
plants2 = merge_phyloseq(twice.m, once); plants2

sort(sample_sums(plants2))
f2rar = rarefy_even_depth(plants2, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = 21915); plants2; f2rar

# now we're ready to have a look at observed species richness:
# make a dataframe for ease of testing and plotting:
obs.df = data.frame(cbind(estimate_richness(f2rar, 
                                            measures = "Observed"), 
                          sample_data(f2rar))); str(obs.df)

hist(obs.df$Observed); shapiro.test(obs.df$Observed) # not statistically significantly different from a normal distribution...
var.test(Observed ~ interval, obs.df) # the variance in the two groups is not significantly different from each other
mod1=t.test(Observed ~ interval, obs.df, var.equal=TRUE)
si=obs.df %>% 
  filter(interval=="single"); sd(si$Observed)
db=obs.df %>% 
  filter(interval=="double"); sd(db$Observed)

# make a nice boxplot to go with the results:
fig3.a.p=obs.df %>% 
  ggplot(aes(x=interval, y=Observed, 
             fill=interval)) + 
  geom_boxplot(alpha = 0.6) + 
  scale_fill_manual(values = c("chartreuse2", 
                               "steelblue1")) +
  theme_classic() + 
  ylab("Observed species richness") +
  scale_x_discrete(labels = c("Double", 
                              "Single")) +
  theme(legend.position = "none") +
  labs(title = "A.", 
       subtitle = "Plants") +
  xlab("Soil sample volume") +
  annotate(geom = "text", 
           x=1.5, 
           y=15, 
           label = paste0("P = ",
                          round(mod1$p.value, 
                                digits = 3)), # annotate rho and p-value
           fontface = "italic", 
           size=3, 
           color="black", 
           hjust=0); fig3.a.p

```

to go along with the results about pots sampled twice, we're interested in the
overall recapture rate of the species that were identified in pots sampled twice.
i.e., were species identified consistently in both samples from the pots they
were identified in? or rather, was two samples (or increased volume) necessary
for identifying certain species in many pots?

```{r}
# we will make two species-by-pot matrices with presence/absence (1/0) data, one 
# for the first samples in every pot and one for the second pot. we'll then merge
# the two matrices, leaving every cell with 0, 1, or 2 identifications per species
# per pot. for every pot, each species will then be
#
#       0 = not identified 
#       1 = identified in one sample
#       2 = identified in both samples
# 
# this will make it easy for us to examine the recapture rate of the different species. 

twice = subset_samples(plants, interval == "double"); twice # subset pots sampled twice

first = subset_samples(twice, grepl(pattern = "_1", # subset first samples
                                    x = twice@sam_data$sample_id)); first = prune_taxa(taxa_sums(first)>0,
                                                                                       first); first
first@sam_data$turn = "first"; head(first@sam_data) # assign variable to distinguish from "second" samples
first@sam_data$row = paste0(first@sam_data$pot_id, # pot ID
                            "_",                   # _
                            first@sam_data$turn)   # turn

second = subset_samples(twice, grepl(pattern = "_2", # second samples
                                    x = twice@sam_data$sample_id)); second = prune_taxa(taxa_sums(second)>0,
                                                                                        second); second
second@sam_data$turn = "second"; head(second@sam_data)
second@sam_data$row = paste0(second@sam_data$pot_id, # pot ID
                             "_",                    # _
                             second@sam_data$turn)   # turn

twice = merge_phyloseq(first, 
                       second); twice # merge back together

sample_names(twice) = twice@sam_data$row; head(twice@sam_data) # assign the new sample names

colnames(twice@otu_table) = twice@tax_table[,6]

# now we make the new data frame with presence/absence data:
pres.abs.df = data.frame(twice@otu_table) %>% 
  mutate_if(is.numeric, ~1 * (. > 0)) 

pres.abs.df.t = data.frame(t(pres.abs.df)) # transpose to make pots columns

# split first and second samples and clean up the colnames before summarizing:
first = data.frame(pres.abs.df.t) %>% 
  select(matches("_first"))
colnames(first) = sub("_first", "", colnames(first))

second = data.frame(pres.abs.df.t) %>% 
  select(matches("_second"))
colnames(second) = sub("_second", "", colnames(second))

# by summarizing the two data frames, we'll be able to see if species were identified
# 0, 1, or 2 times per pot:
pres.abs.df.fin = data.frame(first+second)

# this is where you find the overall recapture rate of 70.3 % --- that does not add up....
# the recapture rate has to be the number of 2 divided by the number of 1s + 2s
table(pres.abs.df.fin==0) # 175 identifications in total (i.e. != 0)
table(pres.abs.df.fin==1) # species X was identified in only one sample per pot a total of 123 times
table(pres.abs.df.fin==2) # species X was identified in both samples per pot a total of 52 times

# check recapture rate for two known alien species to Norway:
con = pres.abs.df.fin["Erigeron_canadensis",] # E. canadensis is synonymous to Conyza canadensis
table(con==0) 
table(con==1) 
table(con==2)

acer = pres.abs.df.fin[rownames(pres.abs.df.fin) %in% "Acer_pseudoplatanus", ]
acer = pres.abs.df.fin["Acer_pseudoplatanus",]
table(acer==0) 
table(acer==1) 
table(acer==2)

```

3. next we want to calculate the fold increase in species richness per pot when
increasing from one to two samples. to do this we will only use data from pots
sampled twice. FI = fold increase, S = sample, Obs = observed species richness:
FI = (Obs S1 + Obs S2) / Obs S1

```{r}
twice = subset_samples(plants, interval == "double"); twice = prune_taxa(taxa_sums(twice)>0,
                                                                         twice); twice
first = subset_samples(twice, grepl(pattern = "_1", 
                                    x = twice@sam_data$sample_id)); first = prune_taxa(taxa_sums(first)>0,
                                                                                       first); first
first@sam_data$turn = "first"; head(first@sam_data) # add a variable to distinguish between first and merged samples
second = merge_samples(twice, group = "pot_id"); second 

# reassign sample data in second:
second@sam_data$pot_id = rownames(second@sam_data) # fix pot_id variable
second@sam_data$pot_id = sub("p","", second@sam_data$pot_id) 
second@sam_data$pot_id = as.numeric(second@sam_data$pot_id) # this will let us sort by pot_id
second.sam = data.frame(second@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id)); head(second.sam); tail(second.sam)



# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(grepl(pattern = "_2", 
               sam$sample_id))

# and reassign variables: 
second.sam$host = sam$host
second.sam$container = sam$container
second.sam$interval = sam$interval
second.sam$turn = "second"; # add a variable to distinguish between merged and first samples

# convert til sample_data() object:
second.sam = sample_data(second.sam); sample_names(second.sam)

# and reassign to twice.m phyloseq object: 
sample_data(second) = second.sam; twice.m; head(second@sam_data)


# now we can merge the two phyloseq objects in order to normalize them:
fiphy = merge_phyloseq(first, second); fiphy

# normalize the new phyloseq object:
sort(sample_sums(fiphy)) # we can normalize at the lowest read depth to keep all samples and only lose two taxa:
fiphyrar = rarefy_even_depth(fiphy, 
                             rngseed = 123, 
                             replace = FALSE, 
                             trimOTUs = TRUE, 
                             sample.size = 10378); fiphy; fiphyrar

# now we have to separate the new object into two dataframes before we combine
# them to calculate and plot fold increase: 
first = subset_samples(fiphyrar, turn=="first")
first.df = data.frame(cbind(estimate_richness(first, 
                                              measures = "Observed"),
                            first@sam_data)) %>% 
  rename("obs_first"="Observed",
         "pot_id_first"="pot_id",
         "turn_first"="turn") %>% 
  mutate(pot_id=pot_id_first); head(first.df)

second = subset_samples(fiphyrar, turn=="second")
second.df = data.frame(cbind(estimate_richness(second, 
                                              measures = "Observed"),
                            second@sam_data)) %>% 
  rename("obs_second"="Observed",
         "pot_id_second"="pot_id",
         "turn_second"="turn") %>% 
  mutate(pot_id=pot_id_second); head(second.df)

fidf = full_join(first.df, second.df, by = "pot_id") %>% 
  select("obs_first", "obs_second", 
         "pot_id", "pot_id_first", "pot_id_second", 
         "turn_first", "turn_second")

fidf = fidf %>% 
  mutate(foldincrease = obs_second/obs_first)
fig3.b.p=ggplot(fidf, aes(x=reorder(pot_id, -foldincrease), 
                 y=foldincrease,
                 fill="darkolivegreen1", color="black")) + 
  geom_col(width=1) +
  scale_fill_manual(values = "darkolivegreen1") +
  scale_color_manual(values = "black") +
  theme_classic() +
  theme(legend.position = "none", 
        axis.ticks.x = element_blank()
      ) + 
  ylab("Fold increase") +
  xlab("Sampled pots") +
  scale_x_discrete(labels = paste0(rep(" ", times=20))) +
  labs(title = "B.",
       subtitle = "Plants") +
  annotate(geom = "text", 
           x=5, 
           y=2.5, 
           label = paste0("Median = ", 
                         round(median(fidf$foldincrease), 
                               digits = 2)), # calculate and annotate manually...
           fontface = "italic", 
           size=3, 
           color="black", 
           hjust=0) +
  scale_y_continuous(breaks = seq(0, 3, 0.5), limits = c(0, 3)) + 
  coord_cartesian(ylim = c(0.9, 3)); fig3.b.p

# additionally, we will investigate whether there is a correlation between 
# the richness in the second sample and fold increase for each pot:
cormod = cor.test(fidf$foldincrease, fidf$obs_second, 
         method = "pearson")
fig3.c.p=ggplot(fidf, aes(x=obs_second, 
                 y=foldincrease,
                 fill="darkolivegreen1")) + 
  theme_classic() +
  theme(legend.position = "none", 
        ) +
  scale_color_manual(values = "black") + 
  scale_fill_manual(values = "darkolivegreen1") +
  geom_point(size=6, pch=21) + 
  geom_smooth(method = "lm", 
              color="black", 
              fill="grey90") +
  scale_x_continuous(breaks = seq(0, 20, 5)) +
  scale_y_continuous(breaks = seq(0, 4, 0.5), 
                    limits = c(0, 3.6)) +
  xlab("Richness in both samples") +
  ylab("\nFold increase") + 
  labs(title = "C.",
       subtitle = "Plants") +
  coord_cartesian(ylim = c(1,3)) + 
  annotate(geom = "text", 
           x=8.8, 
           y=2.8, 
           label = paste0("r = ", 
                          round(cormod$estimate, 
                                digits = 3),
                          "\nP = ",
                          round(cormod$p.value,
                                digits = 3)), 
           fontface = "italic", size=3, color="black", 
           hjust = 0); fig3.c.p


```

we now run the three previous chunks for fungi:

1. sampling strategy (iNEXT):

```{r}

library(iNEXT)

##### less vs more soil per sample

twice = subset_samples(fungi, interval == "double"); twice
twice.m = merge_samples(twice, group = "pot_id"); twice.m 

# reassign sample data in twice.m:
twice.m@sam_data$pot_id = rownames(twice.m@sam_data) # fix pot_id variable
twice.m@sam_data$pot_id = sub("p","",twice.m@sam_data$pot_id) 
twice.m@sam_data$pot_id = as.numeric(twice.m@sam_data$pot_id) # this will let us sort by pot_id
twice.m.sam = data.frame(twice.m@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id))

# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(sample_id!="1_2") %>%
  filter(sample_id!="2_2") %>%
  filter(sample_id!="3_2") %>%
  filter(sample_id!="4_2") %>%
  filter(sample_id!="5_2")

# and reassign variables: 
twice.m.sam$host = sam$host
twice.m.sam$container = sam$container
twice.m.sam$interval = sam$interval

# convert til sample_data() object:
twice.m.sam = sample_data(twice.m.sam); sample_names(twice.m.sam)

# and reassign to twice.m phyloseq object: 
sample_data(twice.m) = twice.m.sam; twice.m; head(twice.m@sam_data)


# now we want to get the merged samples back in the original dataset. we first
# create a new dataset with only samples from pots sampled once: 
once = subset_samples(fungi, interval == "single"); once

twice.m <- twice

# and now we can merge the two phyloseq objects:
fungi2 = merge_phyloseq(twice.m, once); fungi2

sort(sample_sums(fungi2))
f2rar = rarefy_even_depth(fungi, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = min(sample_sums(fungi))); fungi2; f2rar
View(f2rar@sam_data)


cont1 = subset_samples(f2rar, container == "1"); cont1 <- prune_taxa(taxa_sums(cont1)>0, cont1); cont1
cont1inext = data.frame(t(cont1@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c1s <- subset_samples(cont1, interval=="single"); c1s <- prune_taxa(taxa_sums(c1s)>0, c1s); c1s
c1s <- data.frame(t(c1s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c1d <- subset_samples(cont1, interval=="double"); c1d <- prune_taxa(taxa_sums(c1d)>0, c1d); c1d
c1d <- data.frame(t(c1d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

cont2 = subset_samples(f2rar, container == "2"); cont2 <- prune_taxa(taxa_sums(cont2)>0, cont2); cont2
cont2inext = data.frame(t(cont2@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

c2s <- subset_samples(cont2, interval=="single"); c2s <- prune_taxa(taxa_sums(c2s)>0, c2s); c2s
c2s <- data.frame(t(c2s@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))
c2d <- subset_samples(cont2, interval=="double"); c2d <- prune_taxa(taxa_sums(c2d)>0, c2d); c2d
c2d <- data.frame(t(c2d@otu_table)) %>% 
  mutate_if(is.numeric, ~1 *(. !=0))

conts <- list(c1s, c1d, 
              c2s, c2d)

conts.out = iNEXT::iNEXT(conts, 
                         q = 0, 
                         datatype = "incidence_raw", 
                         knots = 40, 
                         #endpoint = 200,
                         se = TRUE
                         )
test <- conts.out

test$DataInfo$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage1", "Cont.1 one/pot", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage2", "Cont.1 two/pot", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage3", "Cont.2 one/pot", test$AsyEst$Assemblage)

test$DataInfo$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$DataInfo$Assemblage)
test$iNextEst$size_based$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$iNextEst$size_based$Assemblage)
test$iNextEst$coverage_based$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$iNextEst$coverage_based$Assemblage)
test$AsyEst$Assemblage <- sub("assemblage4", "Cont.2 two/pot", test$AsyEst$Assemblage)

f3 <- ggiNEXT(test, type = 1, se = F) +
  theme_bw() +
  ggtitle("Doubles vs. singles") + 
  theme(legend.position = "right"); f3
#
  
results <- data.frame(test$AsyEst) %>% 
  filter(Diversity == "Species richness") %>% 
  dplyr::select(-Diversity) %>% 
  mutate(across(c("Estimator", 
                  "s.e.",
                  "LCL",
                  "UCL"), round, 0)) %>% 
  print()

f3 + annotate(geom = "text", x = 10, y = 1000, hjust = 0, 
              label = insight::export_table(results), size = 3) -> f3; f3
#


f3 <- ggiNEXT(test, type = 1, se = F) +
  labs(title = " ", 
       subtitle = "Fungi") + 
  xlab("Sampled pots") +
  theme_classic() +
  scale_color_manual(values = c("orange1", "orange1",
                                "orange4", "orange4"), 
                     labels = c("C. 1 one sample", "C. 1 two samples", 
                          "C. 2 one sample", "C. 2 two samples")) +
  scale_shape_manual(values = c(21, 22, 21, 22),
                     labels = c("C. 1 one sample", "C. 1 two samples", 
                          "C. 2 one sample", "C. 2 two samples")) +
  theme(legend.position = c(0.85, 0.25), 
        legend.direction = "vertical",
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15)
        ); f3
fsac <- ggplot_build(f3)
fsac$data[[1]]$size <- 7
fsac$data[[1]]$colour <- c("black","black","black","black")
fsac$data[[1]]$stroke <- c(1,1,1,1)
fsac$data[[1]]$alpha <- c(0.75, 0.75, 0.75, 0.75)
#fsac$data[[1]]$colour <- c("black", "black", "black", "black")
fsac$data[[1]]$fill <- c("orange1", "orange1",
                         "orange4", "orange4")
fsac <- ggplot_gtable(fsac); plot(fsac)
gridExtra::grid.arrange(psac, fsac, nrow=1)
```



2. soil volume:

```{r}

# we're going to merge samples from the same pots. to do this, we first create a 
# new phyloseq object with only the samples we're going to merge: 
twice = subset_samples(fungi, interval == "double"); twice
twice.m = merge_samples(twice, group = "pot_id"); twice.m 

# reassign sample data in twice.m:
twice.m@sam_data$pot_id = rownames(twice.m@sam_data) # fix pot_id variable
twice.m@sam_data$pot_id = sub("p","",twice.m@sam_data$pot_id) 
twice.m@sam_data$pot_id = as.numeric(twice.m@sam_data$pot_id) # this will let us sort by pot_id
twice.m.sam = data.frame(twice.m@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id))

# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(sample_id!="1_2") %>%
  filter(sample_id!="2_2") %>%
  filter(sample_id!="3_2") %>%
  filter(sample_id!="4_2") %>%
  filter(sample_id!="5_2")

# and reassign variables: 
twice.m.sam$host = sam$host
twice.m.sam$container = sam$container
twice.m.sam$interval = sam$interval

# convert til sample_data() object:
twice.m.sam = sample_data(twice.m.sam); sample_names(twice.m.sam)

# and reassign to twice.m phyloseq object: 
sample_data(twice.m) = twice.m.sam; twice.m; head(twice.m@sam_data)


# now we want to get the merged samples back in the original dataset. we first
# create a new dataset with only samples from pots sampled once: 
once = subset_samples(fungi, interval == "single"); once

# and now we can merge the two phyloseq objects:
fungi2 = merge_phyloseq(twice.m, once); fungi2

sort(sample_sums(fungi2))
f2rar = rarefy_even_depth(fungi2, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE, 
                          sample.size = 237829); fungi2; f2rar

# now we're ready to have a look at observed species richness:
# make a dataframe for ease of testing and plotting:
obs.df = data.frame(cbind(estimate_richness(f2rar, 
                                            measures = "Observed"), 
                          sample_data(f2rar))); str(obs.df)

hist(obs.df$Observed); shapiro.test(obs.df$Observed) # not statistically significantly different from a normal distribution...
var.test(Observed ~ interval, obs.df) # the variance in the two groups is not significantly different from each other
mod1=t.test(Observed ~ interval, 
            obs.df, var.equal=TRUE)
si=obs.df %>% 
  filter(interval=="single"); sd(si$Observed)
db=obs.df %>% 
  filter(interval=="double"); sd(db$Observed)

# make a nice boxplot to go with the results:
fig3.a.f=obs.df %>% 
  ggplot(aes(x=interval, y=Observed, 
             fill=interval)) + 
  geom_boxplot(alpha = 0.6) + 
  scale_fill_manual(values = c("tan1", 
                               "gold1")) +
  theme_classic() + 
  ylab("Observed species richness") +
  scale_x_discrete(labels = c("Double", 
                              "Single")) +
  theme(legend.position = "none") +
  labs(title = " ", 
       subtitle = "Fungi") +
  xlab("Soil sample volume") +
  annotate(geom = "text", 
           x=1.5, 
           y=850, 
           label = paste0("P = <",
                          round(mod1$p.value, 
                                digits = 3),
                          ".001"), # annotate rho and p-value
           fontface = "italic", 
           size=3, 
           color="black", 
           hjust=0); fig3.a.f

```

overall recapture rate:

```{r}
# we will make two species-by-pot matrices with presence/absence (1/0) data, one 
# for the first samples in every pot and one for the second pot. we'll then merge
# the two matrices, leaving every cell with 0, 1, or 2 identifications per species
# per pot. for every pot, each species will then be
#
#       0 = not identified 
#       1 = identified in one sample
#       2 = identified in both samples
# 
# this will make it easy for us to examine the recapture rate of the different species. 

twice = subset_samples(fungi, interval == "double"); twice # subset pots sampled twice

first = subset_samples(twice, grepl(pattern = "_1", # subset first samples
                                    x = twice@sam_data$sample_id)); first = prune_taxa(taxa_sums(first)>0,
                                                                                       first); first
first@sam_data$turn = "first"; head(first@sam_data) # assign variable to distinguish from "second" samples
first@sam_data$row = paste0(first@sam_data$pot_id, # pot ID
                            "_",                   # _
                            first@sam_data$turn)   # turn

second = subset_samples(twice, grepl(pattern = "_2", # second samples
                                    x = twice@sam_data$sample_id)); second = prune_taxa(taxa_sums(second)>0,
                                                                                        second); second
second@sam_data$turn = "second"; head(second@sam_data)
second@sam_data$row = paste0(second@sam_data$pot_id, # pot ID
                             "_",                    # _
                             second@sam_data$turn)   # turn

twice = merge_phyloseq(first, 
                       second); twice # merge back together

sample_names(twice) = twice@sam_data$row; head(twice@sam_data) # assign the new sample names

colnames(twice@otu_table) = twice@tax_table[,7]

# now we make the new data frame with presence/absence data:
pres.abs.df = data.frame(twice@otu_table) %>% 
  mutate_if(is.numeric, ~1 * (. > 0)) 

pres.abs.df.t = data.frame(t(pres.abs.df)) # transpose to make pots columns

# split first and second samples and clean up the colnames before summarizing:
first = data.frame(pres.abs.df.t) %>% 
  select(matches("_first"))
colnames(first) = sub("_first", "", colnames(first))

second = data.frame(pres.abs.df.t) %>% 
  select(matches("_second"))
colnames(second) = sub("_second", "", colnames(second))

# by summarizing the two data frames, we'll be able to see if species were identified
# 0, 1, or 2 times per pot:
pres.abs.df.fin = data.frame(first+second)

# this is where you find the overall recapture rate of 70.3 % 
table(pres.abs.df.fin==0) # 175 identifications in total (i.e. != 0)
table(pres.abs.df.fin==1) # species X was identified in only one sample per pot a total of 123 times
table(pres.abs.df.fin==2) # species X was identified in both samples per pot a total of 52 times

# check recapture rate for two known alien species to Norway:

crypt = pres.abs.df.fin["Cryptostroma_corticale",] # subset C. corticale
table(crypt==0) # C. corticale was unidentified in 13 pots
table(crypt==1) # C. corticale was identified in one sample in 6 pots
table(crypt==2) # C. corticale was identified twice in one pot

mut = pres.abs.df.fin["Mutinus_ravenelii",] # subset M. ravenellii
table(mut==0) 
table(mut==1) 
table(mut==2)

```


2. fold increase:

```{r}
twice = subset_samples(fungi, interval == "double"); twice = prune_taxa(taxa_sums(twice)>0,
                                                                         twice); twice
first = subset_samples(twice, grepl(pattern = "_1", 
                                    x = twice@sam_data$sample_id)); first = prune_taxa(taxa_sums(first)>0,
                                                                                       first); first
first@sam_data$turn = "first"; head(first@sam_data) # add a variable to distinguish between first and merged samples
second = merge_samples(twice, group = "pot_id"); second 

# reassign sample data in second:
second@sam_data$pot_id = rownames(second@sam_data) # fix pot_id variable
second@sam_data$pot_id = sub("p","", second@sam_data$pot_id) 
second@sam_data$pot_id = as.numeric(second@sam_data$pot_id) # this will let us sort by pot_id
second.sam = data.frame(second@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id)); head(second.sam); tail(second.sam)



# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(grepl(pattern = "_2", 
               sam$sample_id))

# and reassign variables: 
second.sam$host = sam$host
second.sam$container = sam$container
second.sam$interval = sam$interval
second.sam$turn = "second"; # add a variable to distinguish between merged and first samples

# convert til sample_data() object:
second.sam = sample_data(second.sam); sample_names(second.sam)

# and reassign to twice.m phyloseq object: 
sample_data(second) = second.sam; twice.m; head(second@sam_data)


# now we can merge the two phyloseq objects in order to normalize them:
fiphy = merge_phyloseq(first, second); fiphy

# normalize the new phyloseq object:
sort(sample_sums(fiphy)) # we can normalize at the lowest read depth to keep all samples and only lose two taxa:
fiphyrar = rarefy_even_depth(fiphy, 
                             rngseed = 123, 
                             replace = FALSE, 
                             trimOTUs = TRUE, 
                             sample.size = 213969); fiphy; fiphyrar

# now we have to separate the new object into two dataframes before we combine
# them to calculate and plot fold increase: 
first = subset_samples(fiphyrar, turn=="first")
first.df = data.frame(cbind(estimate_richness(first, 
                                              measures = "Observed"),
                            first@sam_data)) %>% 
  rename("obs_first"="Observed",
         "pot_id_first"="pot_id",
         "turn_first"="turn") %>% 
  mutate(pot_id=pot_id_first); head(first.df)

second = subset_samples(fiphyrar, turn=="second")
second.df = data.frame(cbind(estimate_richness(second, 
                                              measures = "Observed"),
                            second@sam_data)) %>% 
  rename("obs_second"="Observed",
         "pot_id_second"="pot_id",
         "turn_second"="turn") %>% 
  mutate(pot_id=pot_id_second); head(second.df)

fidf = full_join(first.df, second.df, by = "pot_id") %>% 
  select("obs_first", "obs_second", 
         "pot_id", "pot_id_first", "pot_id_second", 
         "turn_first", "turn_second")

fidf = fidf %>% 
  mutate(foldincrease = obs_second/obs_first)

fig3.b.f=ggplot(fidf, aes(x=reorder(pot_id, -foldincrease), 
                 y=foldincrease,
                 fill="tan1", color="black")) + 
  geom_col(width=1) +
  scale_fill_manual(values = "tan1") +
  scale_color_manual(values = "black") +
  theme_classic() +
  theme(legend.position = "none", 
        axis.ticks.x = element_blank()
      ) + 
  ylab("Fold increase") + 
  xlab("Sampled pots") +
  scale_x_discrete(labels = paste0(rep(" ", times=20))) +
  labs(title = " ",
       subtitle = "Fungi") +
  annotate(geom = "text", 
           x=5, 
           y=1.75, 
           label = paste0("Median = ", 
                         round(median(fidf$foldincrease), 
                               digits = 2)), # calculate and annotate manually...
           fontface = "italic", 
           size=3, 
           color="black", 
           hjust=0) +
  scale_y_continuous(breaks = seq(0, 3, 0.5), limits = c(0, 3)) + 
  coord_cartesian(ylim = c(0.9, 3)); fig3.b.f

# additionally, we will investigate whether there is a correlation between 
# the richness in the second sample and fold increase for each pot:
cormod = cor.test(fidf$foldincrease, fidf$obs_second, 
         method = "pearson")
fig3.c.f=ggplot(fidf, aes(x=obs_second, 
                 y=foldincrease,
                 fill="tan1")) + 
  theme_classic() +
  theme(legend.position = "none", 
        ) +
  scale_color_manual(values = "black") + 
  scale_fill_manual(values = "tan1") +
  geom_point(size=6, pch=21) + 
  geom_smooth(method = "lm", 
              color="black", 
              fill="grey90") +
  #scale_x_continuous(breaks = seq(0, 20, 5)) +
  scale_y_continuous(breaks = seq(0, 4, 0.5), 
                    limits = c(0, 3.6)) +
  xlab("Richness in both samples") +
  ylab("\nFold increase") + 
  labs(title = " ",
       subtitle = "Fungi") +
  coord_cartesian(ylim = c(1,3)) + 
  annotate(geom = "text", 
           x=750, 
           y=2.5, 
           label = paste0("r = ", 
                          round(cormod$estimate, 
                                digits = 3),
                          "\nP = ",
                          round(cormod$p.value,
                                digits = 3)), 
           fontface = "italic", size=3, color="black", 
           hjust = 0); fig3.c.f


```


combine into Fig. 3:

```{r}
fig3 = ggarrange(fig3.a.p,NULL,fig3.b.p,NULL,fig3.c.p,
                 fig3.a.f,NULL,fig3.b.f,NULL,fig3.c.f,
                 nrow=2,ncol=5, 
                 widths = c(3.5, 0.4, 3.5, 0.4, 3.5,
                            3.5, 0.4, 3.5, 0.4, 3.5)); fig3 # pdf landscape 6 x 10
```


###############################################

the following code is for investigating alpha and beta diversity of contaminants. 
it needs some cleaning and explanatory text before implemented above. 

we're interested in how much of an effect container and ornamental host plant
has on the richness and composition of contaminant plants and fungi: 

1.1 plant alpha diversity - mixed effects linear model:

```{r}
# start by normalizing: 
p.rar = rarefy_even_depth(plants, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE,
                          sample.size = 21915); plants; p.rar

# create a data.frame with observed richness and sampling data:
obs = cbind(data.frame(estimate_richness(p.rar,
                                         measures = "Observed"),
                       sample_data(p.rar))); str(obs)

# we do some plotting to explore the data:
obs %>% 
  ggplot(aes(x=container, y=Observed, 
             fill=host)) + 
  geom_boxplot()

# it seems like there is a difference in observed species richness between thuja
# and taxus in container 1 but not in container 2. this indicates an interaction 
# effect between container and host. 

# before fitting our data to a model, we need to figure out what distribution
# best fits our data. we use the package fitdistrplus for this:
library(fitdistrplus) # load package

# we found it difficult to fit the data to a suitable distribution. by square
# root transforming the data, they're not significantly different from a normal
# distribution:
plotdist(sqrt(obs$Observed), 
         histo = TRUE, demp = TRUE) # intial plotting

descdist(sqrt(obs$Observed), 
         boot = 1000) # skewness-kurtosis plot

x=fitdist(sqrt(obs$Observed), 
          distr = "norm", 
          method = "mle"); summary(x); plot(x) 

gofstat(x) # not statistically significant different from a normal distribution. 

# we fit a linear model to test the effect of container and host plant on the
# on observed species richness. include pot_id as a random effect to control
# for the fact that ca. half of the pots were sampled twice: 
library(lmerTest) # for fitting the model
library(effects) # for plotting effects of predictor variables

p.mod = lmerTest::lmer(formula = sqrt(Observed) ~ container * host + (1|pot_id),
                      data = obs); summary(p.mod1); plot(allEffects(p.mod1))

# we'll use DHARMa to validate the model's residuals:
library(DHARMa)
testDispersion(p.mod)

sim.res.p.mod1 = simulateResiduals(p.mod1, 
                                   n = 250,
                                   plot = TRUE) # these simulated residuals look dandy

# review the model results:
p.mod1.res=summary(p.mod1); p.mod1.res
# host and container:host had a significant effect on plant richness in our samples. 
# perform a post-hoc test with emmeans package:
library(emmeans)

p.posthoc <- emmeans(p.mod1, 
                     list(pairwise ~ container*host), 
                     adjust = "Tukey"); p.posthoc # two significant pairwise comparisons
data.frame(p.posthoc$`pairwise differences of container, host`) %>%
  filter(p.value < 0.05) %>% 
  View()
#
```

1.2 plant beta diversity - ordination, permanova, and venn diagrams



1.3 plant sampling strategy - sampling volume (merging samples)

```{r}
# we're going to merge samples from the same pots. to do this, we first create a 
# new phyloseq object with only the samples we're going to merge: 
twice = subset_samples(plants, interval == "double"); twice
twice.m = merge_samples(twice, group = "pot_id"); twice.m 

# reassign sample data in twice.m:
twice.m@sam_data$pot_id = rownames(twice.m@sam_data) # fix pot_id variable
twice.m@sam_data$pot_id = sub("p","",twice.m@sam_data$pot_id) 
twice.m@sam_data$pot_id = as.numeric(twice.m@sam_data$pot_id) # this will let us sort by pot_id
twice.m.sam = data.frame(twice.m@sam_data) %>%  # using arrange() in dplyr
  arrange(pot_id) %>%
  mutate(pot_id=paste0("p",pot_id))

# now make an identical dataframe to get variables from: 
sam = data.frame(twice@sam_data) 
sam = sam %>%
  filter(sample_id!="1_2") %>%
  filter(sample_id!="2_2") %>%
  filter(sample_id!="3_2") %>%
  filter(sample_id!="4_2") %>%
  filter(sample_id!="5_2")

# and reassign variables: 
twice.m.sam$host = sam$host
twice.m.sam$container = sam$container
twice.m.sam$interval = sam$interval

# convert til sample_data() object:
twice.m.sam = sample_data(twice.m.sam); sample_names(twice.m.sam)

# and reassign to twice.m phyloseq object: 
sample_data(twice.m) = twice.m.sam; twice.m; head(twice.m@sam_data)


# now we want to get the merged samples back in the original dataset. we first
# create a new dataset with only samples from pots sampled once: 
once = subset_samples(plants, interval == "single"); once



# 
round(quantile(sample_sums(once)), digits = 1)
round(quantile(sample_sums(twice.m)), digits = 1)

sort(sample_sums(once))
sort(sample_sums(twice.m))
#

# and now we can merge the two phyloseq objects:
plants2 = merge_phyloseq(twice.m, once); plants2
```




2.1 fungal alpha diversity - mixed effects generalized linear model:

```{r}
# normalize: 
f.rar = rarefy_even_depth(fungi, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE,
                          sample.size = min(sample_sums(fungi))); fungi; f.rar

# create a data.frame with observed richness and sampling data:
obs = cbind(data.frame(estimate_richness(f.rar,
                                         measures = "Observed"),
                       sample_data(f.rar))); str(obs)

# we do some plotting to explore the data:
obs %>% 
  ggplot(aes(x=container, y=Observed, 
             fill=host)) + 
  geom_boxplot()

# it seems like there is a difference in observed species richness between thuja
# and taxus, and containers 1 and 2.

# before fitting our data to a model, we need to figure out what distribution
# bets fits our data. we use the package fitdistrplus for this:
library(fitdistrplus) # load package

# we found it difficult to fit the data to a suitable distribution. by log
# transforming the data and dividing by 10, they're not significantly different 
# from a beta distribution:
plotdist(log(obs$Observed), 
         histo = TRUE, demp = TRUE) # 

descdist(log(obs$Observed), 
         boot = 1000) # skewness-kurtosis plot

x=fitdist(log(obs$Observed)/10, 
          distr = "beta", 
          method = "mle"); summary(x); plot(x) 

gofstat(x) # not statistically significantly different from a gamma distribution. 


# fit a simple model to test:
library(glmmTMB)
library(effects)

f.mod = glmmTMB(data = obs,
                      formula = log(Observed)/10 ~ container + host + (1|pot_id),
                      family = beta_family()); summary(fungi.model)
plot(allEffects(f.mod))

library(DHARMa)
testDispersion(f.mod)

simout = simulateResiduals(f.mod, plot = F)
sort(residuals(simout))
plot(simout)

###

# make a pretty boxplot to go with the results: 
fmodbox1 <- obs %>% 
  ggplot(aes(x=container, y=Observed, 
             fill=container)) + 
  geom_boxplot(alpha = 0.75) +
  theme_classic() +
  scale_fill_manual(values = c("orange1", 
                               "orange4")) +
  theme(legend.title = element_blank(),
        legend.position = "none",
        legend.box.background = element_rect(colour = "black", 
                                             size = 1),
        legend.margin = margin(3, 3, 3, 3),
        axis.title.x = element_blank()) +
  ylab("Observed species richness") +
  labs(title = "Contaminant fungal richness", subtitle = "Containers"); fmodbox1

fmodbox2 <- obs %>% 
  ggplot(aes(x=host, y=Observed, 
             fill=host)) + 
  geom_boxplot(alpha = 0.75) +
  theme_classic() +
  scale_fill_manual(values = c("orange1", 
                               "orange4")) +
  theme(legend.title = element_blank(),
        legend.position = "none",
        legend.box.background = element_rect(colour = "black", 
                                             size = 1),
        legend.margin = margin(3, 3, 3, 3), 
        axis.title.x = element_blank()) +
  ylab(" ") +
  labs(title = " ", subtitle = "Host plants"); fmodbox2
fmodbox <- ggarrange(fmodbox1, fmodbox2, nrow = 1); fmodbox
#
```

