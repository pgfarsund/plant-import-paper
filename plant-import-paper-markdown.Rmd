---
title: "plant-import-paper-r-markdown"
author: "pgfarsund"
date: "2023-10-07"
output: github_document
---

```{r}
library(phyloseq)
library(tidyverse)
library(ggpubr)
library(effects)
library(vegan)
```


load, clean, and normalize phyloseq objects:
```{r}
### plants

# load data
plants = readRDS(file = "plants-phyloseq-object.RDS") # change the path to data's location on your computer

# slim down the sample data
sam = data.frame(plants@sam_data) %>%             
  select("sample","Location_name",
         "Specific_host",
         "Sample_ID") %>% 
  rename(c("container"="Location_name", 
           "host"="Specific_host", 
           "sample_id"="Sample_ID")) %>% 
  mutate(sample=sub("PLANTEIMP_21_", "", sample), 
         sample=sub("_ITS_S2_ITS4", "", sample)) 
sample_data(plants) = sample_data(sam); rm(sam); plants

# remove non-focal plants
plants=subset_taxa(plants, phylum=="Streptophyta")
plants=subset_taxa(plants, class!="Chlorophyceae")
plants=subset_taxa(plants, order!="Splachnales")
plants=subset_taxa(plants, order!="Bryales")
plants=subset_taxa(plants, order!="Dicranales")
plants=subset_taxa(plants, order!="Funariales")
plants=subset_taxa(plants, order!="Hypnales")
plants=subset_taxa(plants, order!="Klebsormidiaceae")
plants=subset_taxa(plants, order!="Pottiales")
plants=subset_taxa(plants, order!="Pseudoditrichales")
plants=subset_taxa(plants, species!="Thuja_sp.")
plants=subset_taxa(plants, species!="Thuja_occidentalis")
plants=subset_taxa(plants, species!="Taxus_sp.")
plants=subset_taxa(plants, species!="Taxus_canadensis"); plants



### fungi

# load data
fungi = readRDS(file = "fungi-phyloseq-object.RDS") # change the path to data's location on your computer
fungi = subset_samples(fungi, negative_control=="FALSE")
# slim down the sample data
sam = data.frame(fungi@sam_data) %>% 
  select("sample","Location_name",
         "Specific_host",
         "Sample_ID") %>% 
  rename(c("container"="Location_name", 
           "host"="Specific_host", 
           "sample_id"="Sample_ID")) %>% 
  mutate(sample=sub("PLANTEIMP_21_", "", sample), 
         sample=sub("_fITS7_ITS4", "", sample)) 
sample_data(fungi) = sample_data(sam); rm(sam); fungi
```





1. alpha diversity

we're interested in exploring teh alpha diversity of contaminant plants and fungi.
we're going to fit models to determine which factors are improtant in determining
the diversity and composition of contaminant species in our samples. we'll start 
off by gently exploring the data.

first normalize the number of sequences across samples:

```{r}
quantile(sample_sums(plants)); sort(sample_sums(plants))

# considering the read depth across all the samples, 8629 seems like a fair 
# sample size to retain diversity and power in the dataset: 
p.rar = rarefy_even_depth(plants, 
                          rngseed = 123, 
                          replace = FALSE, 
                          trimOTUs = TRUE,
                          sample.size = 8629); plants; p.rar
```


```{r}

obs = cbind(data.frame(estimate_richness(p.rar,
                                         measures = "Observed"),
                       sample_data(p.rar))); str(obs)

# we do some plotting to explore the data:
obs %>% 
  mutate(host2=host) %>%
ggplot(aes(y=Observed, x=host)) + 
  geom_violin(alpha=0.5, width=0.7, 
              aes(fill=host)) + 
  geom_boxplot(width=0.2, outlier.shape = NA,
               aes(fill=NULL)) + 
  geom_jitter(width=0.4, pch=21, size=3, 
              aes(fill=host2)) +
  scale_fill_manual(values = c("chartreuse1",
                               "chartreuse4")) + 
  facet_wrap(~container) + 
  theme_classic() +
  theme(legend.position = "none")

# it seems like there is a difference in observed species richness between thuja
# and taxus in Bil 1 but not in Bil 2. this indicates an interaction between 
# container and host. 

# fit a simple model to test:
library(lme4)
library(effects)
mod = glm(formula = Observed ~ container*host,
                  data = obs, family = "Gamma") # 
#plot(mod)
summary(mod); plot(effects::allEffects(mod))

#######################

plot_ordination(p.rar, 
                ordinate(p.rar, 
                         method = "PCoA", 
                         distance = "jaccard"), 
                type = "samples", 
                color = "host", 
                shape = "container"
                ) + 
  geom_point(size=3) +
  stat_ellipse()

adonis2(distance(p.rar, 
                 method = "bray",
                 type = "samples") ~ container*host, 
        data = data.frame(p.rar@sam_data))

```




in this first model we want to know which factors are important for the alpha diversity
in each individual soil sample. we therefore include all samples from all pots, and 
will include "pot" as a random effect in our model to account for the fact that